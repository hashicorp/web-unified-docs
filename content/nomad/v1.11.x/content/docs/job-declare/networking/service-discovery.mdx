---
layout: docs
page_title: Configure service discovery
description: |-
   Learn about service discovery in your Nomad job specification. Configure health checks, configuring tags in job specification service blocks, and how to specify tags for canary and blue/green allocations.
---

# Configure service discovery

Service discovery is the process of retrieving the low-level information
necessary to access a service, such as its IP and port, with a high-level
identifier, such as a human-friendly service name.

Nomad stores the service information in a service catalog, which provides
interfaces for querying data. In Nomad there are two service catalogs:

- The native service discovery catalog is embedded in Nomad and requires no
  additional infrastructure.

- The [Consul service discovery catalog][consul_sd] requires access to a
  Consul cluster, but it provides additional features, including a [DNS
  interface][consul_dns] and [service mesh][] capabilities.

Refer to the [service discovery concepts
page](/nomad/docs/networking/service-discovery) to compare Nomad and Consul
service discovery and review use cases.

Services are registered using the [`service`][] block, with the [`provider`][]
parameter defining which catalog to use. Nomad stores the IP and port of all
allocations associated with the service in the catalog and keeps these entries
updated as you schedule new workloads or deploy new versions of your
applications.

```hcl
job "..." {
  # ...
  group "..." {
    service {
      name     = "database"
      port     = "db"
      provider = "nomad"
      # ...
    }
    # ...
  }
}
```

To access services, other allocations can query the catalog using
[`template`][] blocks with the [`service`][ct_service_fn] function to query the
Consul catalog or the [`nomadService`][ct_nomad_service_fn] function when using
Nomad native service discovery. The `template` can then be used as a
configuration file or have its content loaded as environment variables to
configure connection information in applications.

```hcl
job "..." {
  # ...
  group "..." {
    task "..." {
      template {
        data = <<EOF
{{ range nomadService "database" }}
DB_CONNECTION="host={{ .Address }} port={{ .Port }} user=user password=password dbname=db_name"
{{ end }}
EOF
        destination = "local/env.txt"
        env         = true
      }
    }
    # ...
  }
}
```

## Health checks

Both Nomad and Consul services can define health checks to make sure that only
healthy instances are returned by the service catalog. Health checks are
specified using the [`check`][] block.

## Service tags

`service` blocks may be specified multiple times with the same name but for
different ports. All instances are returned when the service name is queried.
To restrict results you can assign [`tags`][] to services to group them. When
querying the service you can provide tag values as part of the service name.

The example below exposes an application on two ports for different protocols.

```hcl
job "..." {
  # ...
  group "..." {
    network {
      port "http" {}
      port "grpc" {}
    }

    service {
      name = "my-app"
      port = "http"
      tags = ["http"]
      # ...
    }

    service {
      name = "my-app"
      port = "grpc"
      tags = ["grpc"]
      # ...
    }
  }
}
```

By assigning different `tags` the port for each protocol can be reached using
the `http.my-app` and `grpc.my-app` service queries.

### Canary deployments

When using [canary][jobspec_update_canary] or
[blue/green][jobspec_update_blue_green] upgrades you can specify a different
set of tags for the canary allocations using the [`canary_tags`][]
configuration.

During a deployment, the new allocations are registered with the tags set in
`canary_tags` while non-canaries have the values in `tags`. Having different
sets of tags allow you to create separate [load balancing][learn_lb] routing
rules to preview canaries.

-> **Note**: Services are registered with either `tags` or `canary_tags`. In
  order to share values they must be set in both fields.

## Examples

### Nomad service discovery 

#### Single service with a health check

This job specification configures a single service and includes a health check.

<CodeBlockConfig highlight="20-32">

```hcl
job "web" {
  datacenters = ["dc1"]
  type = "service"

  group "server" {
    count = 3  # Scale to 3 instances

    network {
      port "http" { to = 80 }
    }

    task "nginx" {
      driver = "docker"
      config {
        image = "nginx:alpine"
        ports = ["http"]
      }
    }

    service {
      provider = "nomad"  # Native discovery
      name = "web-service"
      port = "http"
      tags = ["http", "prod"]

      check {
        type = "http"
        path = "/"
        interval = "10s"
        timeout = "2s"
      }
    }
  }
}
```

</CodeBlockConfig>

#### Dynamic upstream discovery

This job specification illustrates dynamic upstream discovery with a template.
The `api` task discovers `db-service` addresses dynamically and injects them
into the `UPSTREAMS` environment variable.

<CodeBlockConfig highlight="11-18,20-26">

```hcl
job "api" {
  datacenters = ["dc1"]

  group "api" {
    network { port "api" { to = 8080 } }

    task "app" {
      driver = "docker"
      config { image = "my-api:latest" }

      template {
        data = <<EOH
UPSTREAMS={{ range nomadService "db-service" }}{{ .Address }}:{{ .Port }},{{ end }}
EOH
        destination = "local/upstreams.env"
        env = true  # Inject as env vars
      }
    }

    service {
      provider = "nomad"
      name = "api-service"
      port = "api"
      meta { version = "v1" }  # Custom metadata
    }
  }

  group "db" {  # Separate group for upstream
    task "db" { driver = "docker" config { image = "postgres:latest" } }

    service {
      provider = "nomad"
      name = "db-service"
      port = "db"
      address_mode = "host"  # Use host IP
    }
  }
}
```

</CodeBlockConfig>

#### Batch job

This job specification configures a short-lived batch job to use Nomad service
discovery.

<CodeBlockConfig>

```hcl
job "batch" {
  type = "batch"

  group "processor" {
    task "script" {
      driver = "exec"
      config { command = "/bin/echo" args = ["Processing..."] }
    }

    service {
      provider = "nomad"
      name = "batch-processor"
      check { type = "script" command = "/bin/true" interval = "5s" }  # Check
    }
  }
}
```

</CodeBlockConfig>

[`canary_tags`]: /nomad/docs/job-specification/service#canary_tags
[`check`]: /nomad/docs/job-specification/check
[`provider`]: /nomad/docs/job-specification/service#provider
[`service`]: /nomad/docs/job-specification/service
[`tags`]: /nomad/docs/job-specification/service#tags
[`template`]: /nomad/docs/job-specification/template#examples
[consul_dns]: /consul/docs/services/discovery/dns-overview
[consul_sd]: /consul/docs/concepts/service-discovery
[ct_nomad_service_fn]: https://github.com/hashicorp/consul-template/blob/main/docs/templating-language.md#nomadservice
[ct_service_fn]: https://github.com/hashicorp/consul-template/blob/main/docs/templating-language.md#service
[jobspec_update_blue_green]: /nomad/docs/job-specification/update#blue-green-upgrades
[jobspec_update_canary]: /nomad/docs/job-specification/update#canary-upgrades
[learn_lb]: /nomad/tutorials/load-balancing
[service mesh]: /nomad/docs/job-declare/consul-service-mesh

