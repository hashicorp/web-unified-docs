---
layout: docs
page_title: Monitor Consul with AppDynamics CNS
description: >-
  Use HashiCorp's Consul Monitoring Extension for AppDynamics CNS to collect Consul telemetry data and node information.
---

# Monitor Consul with AppDynamics CNS

This page describes the process to monitor Consul telemetry data with the Consul monitoring extension for AppDynamics CNS.

## Introduction

Consul produces a range of metrics in various formats that reflect the health and stability of a datacenter and can help diagnose or predict potential issues.

AppDynamics CNS can collect Consul telemetry data and node information using the [HashiCorp Consul Monitoring Extension](https://github.com/hashicorp/consul-appd-extension).
Consul agents need the [AppDynamics Machine Agent](https://docs.appdynamics.com/display/PRO45/Infrastructure+Visibility) installed and also need to meet its [requirements](https://docs.appdynamics.com/display/PRO45/Standalone+Machine+Agent+Requirements+and+Supported+Environments). AppDynamics SaaS or On-Prem controller version 4.5 or greater are required.
Furthermore the agents will use [statsite](https://github.com/statsite/statsite) as a metrics aggregator to collect node telemetry metrics.

The extension also provides you with two example dashboards that can be imported into your AppDynamics controller.

## Workflow

1. [Install AppDynamics Machine Agent including the JRE on the Consul nodes.](#Install-AppDynamics-Machine-Agent-bundle)
1. [Install HashiCorp Consul Monitoring Extension for AppDynamics CNS.](#Install-AppDynamics-machine-agent-for-Consul-telemetry-and-statsite)
1. [Configure Consul to send telemetry data to the AppDynamics agent.](#Configure-Consul-to-send-metrics-to-statsite)

### Install AppDynamics Machine Agent bundle

First, you must install and configure the [AppDynamics Machine Agent](https://download.appdynamics.com/download/#version=&apm=machine&os=&platform_admin_os=&appdynamics_cluster_os=&events=&eum=&page=1) on your Consul nodes, so that later Consul can send telemetry data to it. An official installation guide is available on the [AppDynamics documentation website](https://docs.appdynamics.com/display/PRO45/Linux+Install+Using+ZIP+with+Bundled+JRE).

Then you must configure the AppDynamics Machine Agent to communicate with the controller when running in standalone mode. This requires editing the controller file `/appdynamics/machine-agent/conf/controller-info.xml` with your AppDynamics Controller access information. Refer to [configure the Standalone Machine Agent](https://docs.appdynamics.com/display/PRO45/Configure+the+Standalone+Machine+Agent) for the configuration reference.

We recommend to increase the value of the `maxMetrics` variable so that metric data is not truncated. The default location of the service definition file is `/etc/systemd/system/appdynamics-machine-agent.service`. An example that replaces the default environment variable is shown below:

   ```shell-session
   $ sed -i 's/#Environment="JAVA_OPTS=-D<sys-property1>=<value1> -D<sys-property2>=<value2>"/Environment="JAVA_OPTS=-Dappdynamics.agent.maxMetrics=10000"/g' /etc/systemd/system/appdynamics-machine-agent.service
   ```

### Install AppDynamics machine agent for Consul telemetry and statsite

Next you will configure the AppDynamics machine agent to generate telemetry data for Consul. From the [consul-appd-extension](https://github.com/hashicorp/consul-appd-extension) repository, copy the folder `statsite` into `/opt/appdynamics/machine-agent/monitors/`.

This extension uses statsite to import statsd Consul metrics into AppDynamics. Place the `statsite` executable into the `/opt/appdynamics/machine-agent/monitors/statsite` folder for every node you want to monitor. Refer to the official [statsite installation guide](https://github.com/statsite/statsite/blob/master/INSTALL.md) to find how to install it.

### Configure Consul to send metrics to statsite

You will next configure your Consul agents to send their telemetry data to AppDynamics CNS via statsite by adding the following configuration to your Consul agent configuration file.

<Tabs>
<Tab heading="HCL">

<CodeBlockConfig filename="consul-statsite.hcl">

```hcl
telemetry {
  dogstatsd_addr = "localhost:8125"
}
```

</CodeBlockConfig>

</Tab>
<Tab heading="JSON">

<CodeBlockConfig filename="consul-statsite.json">

```json
{
  "telemetry": {
    "statsite_address": "localhost:8125"
  }
}
```

</CodeBlockConfig>

</Tab>
</Tabs>

## Explore telemetry metrics

For a complete list of Consul metrics supported by these integrations, as well as details on what each metric means, consult the Consul [telemetry documentation](/consul/docs/reference/agent/telemetry).

All metrics reported by the extension will be available in the Metric Browser at `Controller > Applications > Application > Metric Browser`.

- `Application Infrastructure Performance > Consul > Custom Metrics > statsd > consul`
  lists the available Consul metrics:

![AppDynamics CNS Custom Metrics Consul](/img/cloud-integrations/appdynamics-ui-available-metrics-consul.png)

- `Application Infrastructure Performance > Consul > Custom Metrics > statsd > envoy`
  lists metrics available for the Connect service mesh.

![AppDynamics CNS Custom Metrics Service Mesh ](/img/cloud-integrations/appdynamics-ui-available-metrics-service-mesh.png)

### Custom dashboard

The [consul-appd-extension](https://github.com/hashicorp/consul-appd-extension) repository provides two custom dashboards to get you started on monitoring Consul. They are JSON files located in the [dashboards](https://github.com/hashicorp/consul-appd-extension/tree/master/dashboards) folder. First you must change the value for the key `applicationName` within the templates to match your application name. Then you import these dashboards into your AppDynamics controller from `Dashboards & Reports tab > Dashboards > Import`. Once imported, the dashboards will be available in the `Dashboard & Reports tab`.

![AppDynamics CNS Custom Dashboard Consul Metrics](/img/cloud-integrations/appdynamics-ui-dashboard-consul.png)

![AppDynamics CNS Custom Dashboard Service Mesh Metrics](/img/cloud-integrations/appdynamics-ui-dashboard-service-mesh.png)


### Custom health rules

AppDynamics CNS provides the ability to customize health rules, which are the policy statements that define event triggers. Health rules for Consul are created against the applications that are using its service discovery and service mesh so that the metrics for the application as well as Consul can be seen against particular applications in AppDynamics.

![AppDynamics CNS custom health rules screen](/img/cloud-integrations/appdynamics-ui-health-rules.png)

## Next steps

For more information about personalizing your dashboards, refer to [creating custom dashboards](https://docs.appdynamics.com/display/PRO45/Custom+Dashboards) in the AppDynamics documentation.