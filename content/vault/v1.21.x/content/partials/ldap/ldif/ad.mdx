<Note>

  Windows Servers hosting Active Directory include a configuration setting that
  lets clients authenticate with old passwords for a specified amount of time.

  Refer to the &nbsp;
  <a href="https://learn.microsoft.com/troubleshoot/windows-server/windows-security/new-setting-modifies-ntlm-network-authentication">
    Setting in NTLM network authentication behavior
  </a> &nbsp;
  guidance on learn.microsoft.com if you want to change that behavior.

</Note>

To create a user programmatically in Active Directory, you first `add` a user
object and then `modify` that user to provide a password using the `unicodePwd`
field and enable the account. 

Passwords entries must:

- Start with two (2) colons (`::`).
- Be enclosed in double quotes (`" "`).
- Be writen in
  [`UTF16LE` format](https://learn.microsoft.com/openspecs/windows_protocols/ms-adts/6e803168-f140-4d23-b2d3-c3a8ab5917d2).
- Use `base64`-encoding.

Once you set the password, you can enable the account with the
[`userAccountControl`](https://learn.microsoft.com/troubleshoot/windows-server/active-directory/useraccountcontrol-manipulate-account-properties#property-flag-descriptions)
field:

`userAccountControl` | Result
-------------------- | -----------
`512`                 | Enables the account 
`65536`               | Disable AD password expiration for the dynamic user account 

You set `userAccountControl` flags cumulatively. For example, to enable the
account and disable password expiration, set `userAccountControl` to `66048` :

```text 
(enable + disable password) = 512 + 65536 = 66048
```

If you need backward compatibility with legacy Windows NT systems, you can use
[`sAMAccountName`](https://learn.microsoft.com/windows/win32/adschema/a-samaccountname),
which has a limit of 20 characters . Keep the character limit in mind when
defining `username_template`, which typically looks like
`v_{{.DisplayName}}_{{.RoleName}}_{{random 10}}_{{unix_time}}`.

We recommend customizing
[the username template](/vault/docs/concepts/username-templating) in your role
configuration to generate accounts with names less than 20 characters if you 
need backward compatibility.

Example LDIF file:

```ldif
dn: CN={{.Username}},OU=HashiVault,DC=adtesting,DC=lab
changetype: add
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
userPrincipalName: {{.Username}}@adtesting.lab
sAMAccountName: {{.Username}}

dn: CN={{.Username}},OU=HashiVault,DC=adtesting,DC=lab
changetype: modify
replace: unicodePwd
unicodePwd::{{ printf "%q" .Password | utf16le | base64 }}
-
replace: userAccountControl
userAccountControl: 66048
-

dn: CN=test-group,OU=HashiVault,DC=adtesting,DC=lab
changetype: modify
add: member
member: CN={{.Username}},OU=HashiVault,DC=adtesting,DC=lab
-
```

<Note>

  Active Directory does not let you add dynamic users directly to groups by
  modifying the `memberOf` attribute because `memberOf` is the back-link half of a
  [linked attribute pair](https://learn.microsoft.com/windows/win32/ad/linked-attributes)
  with the `member` attribute of a group. You can only modify the forward
  attribute of a linked pair.

  To add a newly-created dynamic user to a group, you must issue a `modify`
  request to the desired group and update the group membership with the new user.

</Note>
