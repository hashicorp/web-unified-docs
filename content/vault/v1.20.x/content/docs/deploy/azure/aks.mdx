---
layout: docs
page_title: Deploy Vault on Microsoft AKS
description: >-
  Guide to deploying and setting up Vault on Microsoft Azure Kubernetes Service (AKS).
---

# Deploy Vault on Azure Kubernetes Service (AKS)

You can run Vault in Azure Kubernetes Service (AKS) can run Vault in a managed Kubernetes cluster web-based secrets management.

In this guide, you create a cluster in AKS, install Vault with the Web UI enabled, and then configure the authentication between Vault and the cluster. Then you deploy a web application with deployment annotations so the Vault Agent injector service installs application's.

## Before you start

This guide focuses on setting up HashiCorp Vault on Azure AKS and assumes a understanding of both Azure Kubernetes concepts and terminology.  The guide assumes the user is familiar with Azure groups, AKS, Kubernetes pods, service accounts, and manifests.  

- You should be familiar with Kubernetes concepts like pods, service accounts, and manifests.
- You should be comfortable working with:
   - [Azure Kubernetes Service (AKS)](https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes).
   - [Helm charts](https://helm.sh/docs/topics/charts).
- You should have a [Azure account](https://azure.microsoft.com/en-us/account/) and know your [tenant id](https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id).
- You must have the following CLIs installed:
   - [Azure command-line interface (cli)](https://docs.microsoft.com/en-us/cli/azure/)
   - [`kubectl`](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
   - [`helm`](https://helm.sh/docs/helm/)
- You should have [jq](https://jqlang.org/) installed.

## Step 1: Add the HashiCorp repository to Helm

@include 'how-tos/helm-repo.mdx'

## Step 2: Start AKS cluster

1. You should log in to Azure via the CLI and have a subscription and region selected.

   ```shell-session
   $ az login --tenant <your tenant id>
   ```

1. Create a resource group named `learn-vault` with the location specified.

   ```shell-session
   $ az group create --name learn-vault --location eastus
   ```

1. Create a cluster named `learn-vault-cluster` with `1` node in the `learn-vault` resource group.

   ```shell-session
   $ az aks create --resource-group learn-vault \
      --name learn-vault-cluster \
      --node-count 1 \
      --enable-addons monitoring \
      --generate-ssh-keys
   ```

1. When the cluster is ready, configure the `kubectl` CLI to communicate to the `learn-vault-cluster` cluster.

   ```shell-session
   $ az aks get-credentials --resource-group learn-vault --name learn-vault-cluster
   ```

1. Helm deploys the Vault pod and Vault Agent Injector pod in the default namespace.

   ```shell-session
   $ helm install vault hashicorp/vault --set 'server.dev.enabled=true'
   ```

The `vault-agent-injector` pod deployed is a Kubernetes Mutation Webhook Controller. The controller intercepts pod events and applies mutations to the pod if specific annotations exist within the request.

## Step 2: Install Vault

The Vault Helm chart contains all the necessary components to run Vault in several different modes.

1. Create a file named `helm-vault-raft-values.yml` with the following contents:

   ```shell-session
   $ cat > helm-vault-raft-values.yml <<EOF
   server:
      affinity: ""
      ha:
         enabled: true
         raft:
            enabled: true
            setNodeId: true
            config: |
               cluster_name = "vault-integrated-storage"
               storage "raft" {
                  path    = "/vault/data/"
               }

               listener "tcp" {
                  address = "[::]:8200"
                  cluster_address = "[::]:8201"
                  tls_disable = "true"
               }
               service_registration "kubernetes" {}
   EOF
   ```

   <Note title="Recommendation">

   If you are using Prometheus for monitoring and alerting, we recommend to set the `cluster_name` in the HCL configuration.  use the `config` parameter in the Vault Helm chart.

   </Note>

   Helm deploys the Vault pods and Vault Agent Injector pod in the default namespace.

1. Install the latest version of the Vault Helm chart with Integrated Storage.

   ```shell-session
   $ helm install vault hashicorp/vault --values helm-vault-raft-values.yml
   ```

   This creates three Vault server instances with an Integrated Storage (Raft) backend. 

   Helm installs the Vault pods and Vault Agent Injector pod in the default namespace.

## Step 3: Install Vault using helm

@include 'how-tos/helm-install.mdx'

## Step 4: Initialize and unseal the primary Vault pod

@include 'how-tos/initialise.mdx'

## Step 5: Join additional nodes to the Vault cluster

@include 'how-tos/join.mdx'

## Step 6: Test your cluster deployment 

@include 'how-tos/test.mdx'

## Step 7: Create a Kubernetes service account for clients

@include 'how-tos/kubernetes/sa.mdx'

## Step 8: Enable Kubernetes authentication

@include 'how-tos/kubernetes/auth.mdx'

## Step 9: Validate secret available to sample application

@include 'how-tos/validate.mdx'

## Step 10: Clean up

Destroy the cluster.

```shell-session
$ az group delete --name learn-vault --yes --no-wait
```
## Next steps

@include 'how-tos/next-steps.mdx'

## Additional resources

@include 'how-tos/additional-resources.mdx'

