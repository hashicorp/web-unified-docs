---
layout: docs
page_title: Deploy Vault on Amazon EKS Anywhere
description: >-
  Guide to deploying and setting up Vault on Amazon EKS Anywhere.
---

This guide provides guidance on deploying Vault in Amazon Elastic Kubernetes
Service (EKS) Anywhere. Amazon EKS Anywhere is a new deployment option for
Amazon EKS that allows customers to create and operate Kubernetes clusters on
customer-managed infrastructure, supported by AWS. There are several layers in
this stack and this tutorial will help you set up your infrastructure
end-to-end.

The bottom-most layer of the stack consists of Bare Metal with VMware's vSphere
as the first layer of abstraction. Amazon EKS runs on top of that as the
Kubernetes distribution with Vault running as the secrets manager for it. 

## Prerequisites

This tutorial requires the following prerequisites to follow this tutorial:

- A copy of  `VMware-VCSA-all-<version>.iso` is in an s3 bucket in your AWS account.
- Download the version of the [vSan Management SDK for
Python](https://developer.broadcom.com/sdks/vsan-management-sdk-for-python/latest) matching the version ofthe server in the previous step.  Copy the **bindings >vsanmgmtObjects.py** and **samplecode>vsanapiutils.py** to the s3 bucket.
- The Amazon S3 bucket should look similar to the following

<CodeBlockConfig hideClipboard>

```plain-text
Object Store Root: 
    |__ Bucket_Name 
        |__ VMware-VCSA-all-7.0.3-18700403.iso
        |__ vsanapiutils.py
        |__ vsanmgmtObjects.py
```

</CodeBlockConfig>

- AWS account with permissions for S3 and EKS services  
- [AWS CLI](https://aws.amazon.com/cli/)
- [eksctl](https://eksctl.io/)
- [AWS EKS Anywhere CLI](https://anywhere.eks.amazonaws.com/docs/getting-started/)
- [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
- [Helm CLI](https://helm.sh/docs/helm/)
- [Amazon EKS Anywhere cluster](https://anywhere.eks.amazonaws.com/docs/tasks/cluster/cluster-verify/) already deployed
- Vault Enterprise license (if using Enterprise version of Vault)

## EKS clusters on Equinix Metal
## TODO: is there no more vCenter?
To setup vCenter cluster using Equinix Bare Metal services follow these steps, for a more detailed setup follow the instructions for the [Workshop: EKS Anywhere on Equinix Metal](https://equinix-labs.github.io/eks-anywhere-on-equinix-metal-workshop/) on their website.

## Deploy Vault on Amazon EKS Anywhere

Vault installation on Amazon EKS Anywhere is same as any kubernetes
installation. For a step-by-step instruction, refer to the [Vault on Kubernetes
Deployment Guide](/vault/tutorials/kubernetes/kubernetes-raft-deployment-guide).

1. Create a configuration file to configure Vault installation.

   ```shell-session 
   $ vi config.yaml
   server:
     standalone:
       enabled: true
       config: |
         ui = true

         listener "tcp" {
           tls_disable = 1
           address = "[::]:8200"
           cluster_address = "[::]:8201"
         }
         storage "file" {
           path = "/vault/data"
         }
     service:
       enabled: true
   ui:
     enabled: true
     serviceType: NodePort
   ```

1. To access the Vault Helm chart, add the Hashicorp Helm repository.

   ```shell-session 
   $ helm repo add hashicorp https://helm.releases.hashicorp.com
   ```

1. Install the Vault helm chart. 

   ```shell-session 
   $ helm install vault hashicorp/vault --namespace vault -f config.yaml
   ```

1. Initialize and unseal Vault.

1. Unseal the Vault server using the unseal keys until the key threshold is met.

   ```shell-session 
   $ kubectl exec --stdin=true --tty=true vault-0 -- vault operator unseal 
   Unseal Key (will be hidden):
   ```
   
   When prompted, enter the Unseal Key 1 value.

   ```shell-session 
   $ kubectl exec --stdin=true --tty=true vault-0 -- vault operator unseal 
   Unseal Key (will be hidden):
   ```
   
   When prompted, enter the Unseal Key 2 value.
   
   ```shell-session 
   $ kubectl exec --stdin=true --tty=true vault-0 -- vault operator unseal 
   Unseal Key (will be hidden):
   ```
   
   When prompted, enter the Unseal Key 3 value.

1. Validate that Vault is up and running. 

   ```shell-session 
   $ kubectl get pods --selector='app.kubernetes.io/name=vault'

   NAME                                    READY   STATUS    RESTARTS   AGE
   vault-0                                 1/1     Running   0          1m49s
   vault-1                                 1/1     Running   0          1m49s
   ```

1. Display all Vault services.

   ```shell-session 
   $ kubectl get services -n vault --selector='app.kubernetes.io/name=vault-ui'

   NAME       TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
   vault-ui   NodePort   10.97.113.241   <none>        8200:30096/TCP   16d
   ```

1. Display the nodes of the cluster.

   ```shell-session 
   $ kubectl get nodes

   NAME           STATUS   ROLES                  AGE   VERSION
   172.16.0.134   Ready    <none>                 16d   v1.21.6
   172.16.0.53    Ready    <none>                 16d   v1.21.6
   172.16.0.63    Ready    control-plane,master   16d   v1.21.6
   172.16.0.97    Ready    control-plane,master   16d   v1.21.6
   ```

1. Install the HashiCorp tap, a repository of all our Homebrew packages.

   ```shell-session 
   $ brew tap hashicorp/tap
   ```

1. Install Vault with hashicorp/tap/vault.

   ```shell-session 
   $ brew install hashicorp/tap/vault
   ```

1. Set the `VAULT_ADDR` environment variable. Since we exposed Vault using
`NodePort`, Vault will be available at `172.16.0.97:8200`. Access it from your
bastion host or VPN from the [optional
step](#setup-vpn-to-connect-to-vcenter-cluster-via-cli-optioal).

   ```shell-session 
   $ export VAULT_ADDR='http://172.16.0.97:30096'
   ```

1. Set the `VAULT_TOKEN` environment variable value to the initial root token
value generated during the Vault initialization.

   ```shell-session
   $ export VAULT_TOKEN="s.zJNwZlRrqISjyBHFMiEca6GF"
   ```

1. Enable the kv secrets engine.

   ```shell-session 
   $ vault secrets enable -path=kv kv

   Success! Enabled the kv secrets engine at: kv/
   ```

 1. Store some test data at `kv/hello`.
 
   ```shell-session 
   $ vault kv put kv/hello target=world

   Key                Value
   ---                -----
   created_time       2022-03-21T21:23:00.540998543Z
   custom_metadata    <nil>
   deletion_time      n/a
   destroyed          false
   version            1
   ```

1. Read the stored data to verify. 

   ```shell-session 
   $ vault kv get kv/hello

   ======= Metadata =======
   Key                Value
   ---                -----
   created_time       2022-03-21T21:23:00.540998543Z
   custom_metadata    <nil>
   deletion_time      n/a
   destroyed          false
   version            1

   ===== Data =====
   Key       Value
   ---       -----
   target    world
   ```

### Configure Kubernetes auth method

<Note>

 Refer to the [Vault Agent with
Kubernetes](/vault/tutorials/kubernetes/agent-kubernetes) tutorial for more details.

</Note>

1. Retrieve the additional configuration by cloning the
`hashicorp/learn-vault-agent` repository from GitHub.

   ```shell-session 
   $ git clone https://github.com/hashicorp-education/learn-vault-agent
   ```

1. Change the working directory to `learn-vault-agent/vault-agent-k8s-demo`.

   ```shell-session 
   $ cd learn-vault-agent/vault-agent-k8s-demo
   ```

1. Update the vault-auth service account.

   ```shell-session 
   $ kubectl apply --filename vault-auth-service-account.yaml
   ```

1. Create a read-only policy, `myapp-kv-ro` in Vault.

   ```shell-session
   $ vault policy write myapp-kv-ro - <<EOF
   path "secret/data/myapp/*" {
       capabilities = ["read", "list"]
   }
   EOF
   ```

1. Create some test data at the `secret/myapp` path.

   ```shell-session
   $ vault kv put secret/myapp/config \
         username='appuser' \
         password='suP3rsec(et!' \
         ttl='30s'
   ```

1. Set the `K8S_HOST` environment variable value to minikube IP address.

   ```shell-session
   $ export K8S_HOST=$(kubectl config view --raw --minify --flatten \
       --output 'jsonpath={.clusters[].cluster.server}')
   ```

1. Enable the Kubernetes auth method at the default path.

   ```shell-session
   $ vault auth enable kubernetes
   
   Success! Enabled kubernetes auth method at: kubernetes/
   ```

1. Configure the kubernetes auth method.

   <Note title="Version compatibility">

   Starting in v1.24, Kubernetes will no longer
      auto-generate the [Secret
      object](https://kubernetes.io/docs/concepts/configuration/secret/#service-account-token-secrets).
      So, for the best compatibility with recent Kubernetes versions, ensure you
      are using Vault v1.9.3 or greater.

   </Note>

   ```shell-session
   $ vault write auth/kubernetes/config \
        kubernetes_host="$K8S_HOST"
   ```

   **Output:** 
   
   <CodeBlockConfig hideClipboard>
   
   ```plaintext
   Success! Data written to: auth/kubernetes/config
   ```
   
   </CodeBlockConfig>

1. Create a role named, `example`, that maps the Kubernetes Service Account to
   Vault policies and default token TTL.

   ```shell-session
   $ vault write auth/kubernetes/role/example \
        bound_service_account_names=vault-auth \
        bound_service_account_namespaces=default \
        token_policies=myapp-kv-ro \
        ttl=24h
   ```

   **Output:** 
   
   <CodeBlockConfig hideClipboard>
   
   ```plaintext
   Success! Data written to: auth/kubernetes/role/example
   ```
   
   </CodeBlockConfig>

### Verify the Kubernetes auth method configuration

1. Create a variable named `EXTERNAL_VAULT_ADDR`.

   ```shell-session
   $ export EXTERNAL_VAULT_ADDR="172.16.0.97:30096"
   ```
   
1. Define a Pod with a container.

   ```shell-session
   $ cat > devwebapp.yaml <<EOF
   apiVersion: v1
   kind: Pod
   metadata:
     name: devwebapp
     labels:
       app: devwebapp
   spec:
     serviceAccountName: vault-auth
     containers:
       - name: devwebapp
         image: burtlo/devwebapp-ruby:k8s
         env:
           - name: VAULT_ADDR
             value: "http://$EXTERNAL_VAULT_ADDR:8200"
   EOF
   ```

   The Pod is named `devwebapp` and runs with the `vault-auth` service account.

1. Create the `devwebapp` pod in the `default` namespace

   ```shell-session
   $ kubectl apply --filename devwebapp.yaml --namespace default
   ```

1. Display all the pods in the default namespace.

   ```shell-session
   $ kubectl get pods
   
   NAME        READY   STATUS    RESTARTS   AGE
   devwebapp   1/1     Running   0          77s
   ```

   Wait until the `devwebapp` pod is running and ready (`1/1`).

1. Start an interactive shell session on the `devwebapp` pod.

   ```shell-session
   $ kubectl exec --stdin=true --tty=true devwebapp -- /bin/sh
   #
   ```

   Your system prompt is replaced with a new prompt `#`.

1. Set `KUBE_TOKEN` to the service account token.

   ```shell-session
   $ export KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
   ```

1. Authenticate with Vault through the `example` role with the `KUBE_TOKEN`.

   ```shell-session
   $ curl --request POST \
       --data '{"jwt": "'"$KUBE_TOKEN"'", "role": "example"}' \
       $VAULT_ADDR/v1/auth/kubernetes/login
   ```
   
   **Example output:** 
   
   <CodeBlockConfig hideClipboard>
   
   ```json 
   {
     "request_id": "2febc920-6feb-182a-19cd-c95c0cd70bf7",
     "lease_id": "",
     "renewable": false,
     "lease_duration": 0,
     "data": null,
     "wrap_info": null,
     "warnings": null,
     "auth": {
       "client_token": "s.ZOZk5OkIW1rbdMEqGmwJW7vj",
       "accessor": "yPwZcQG6LP721LryKzkgA4eA",
       "policies": [
         "default",
         "myapp-kv-ro"
       ],
       "token_policies": [
         "default",
         "myapp-kv-ro"
       ],
       "metadata": {
         "role": "example",
         "service_account_name": "vault-auth",
         "service_account_namespace": "default",
         "service_account_secret_name": "",
         "service_account_uid": "649f0652-42ef-44ba-a416-76862bc1b6c3"
       },
       "lease_duration": 86400,
       "renewable": true,
       "entity_id": "3f684285-bc1c-6b9e-e580-4ce310c956b2",
       "token_type": "service",
       "orphan": true
     }
   }
   ```
   
   </CodeBlockConfig>

## Help and reference

- [Injecting Secrets into Kubernetes Pods via Vault Agent Containers](/vault/tutorials/kubernetes/kubernetes-sidecar)
- [Vault Installation to Amazon Elastic Kubernetes Service via Helm](/vault/tutorials/kubernetes/kubernetes-amazon-eks)
- [Vault documentation](/vault/docs/platform/k8s)