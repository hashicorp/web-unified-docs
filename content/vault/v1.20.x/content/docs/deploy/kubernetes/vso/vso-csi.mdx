---
layout: docs
page_title: Vault Secrets Operator CSI Driver
description: >-
  The Vault Secrets Operator CSI Driver allows for mounting secrets from Vault directly into application containers.
---

# Vault Secrets Operator CSI Driver

While the default settings for the Vault Secrets Operator allow for Vault secrets to be stored in the cluster as native Kubernetes Secrets, 
running it with the CSI driver option allows for mounting Vault secrets directly to containers, bypassing Kubernetes Secrets altogether.

~> The Vault Secrets Operator CSI driver requires **Vault Enterprise**.

## Overview

A [Container Storage Interface](https://github.com/container-storage-interface/spec/blob/master/spec.md) (CSI) is a standardized approach to managing pod volumes in Kubernetes. 
Running the Vault Secrets Operator in CSI driver mode can provide Vault Enterprise users the ability to fetch secrets 
from Vault and mount them directly to their containers as volumes.

By hooking into the pod volume lifecycle, the Vault Secrets Operator CSI driver can deliver Vault secrets to users seeking to avoid the use of Kubernetes Secrets in their workflows.

Traditional Vault Secrets Operator:
[![Vault Secrets Operator flow of secrets](/img/vso_secrets_flow.png)](/img/vso_secrets_flow.png)

Vault Secrets Operator CSI driver:
[![Vault Secrets Operator CSI driver flow of secrets](/img/vso_csi_secrets_flow.png)](/img/vso_csi_secrets_flow.png)

The Vault Secrets Operator CSI driver operates by watching for the creation or modification of a Custom Resource (CR) called a `CSISecrets`.
The [CSISecrets](/vault/docs/deploy/kubernetes/vso/api-reference#csisecrets) resource contains a declarative list of secrets to fetch, as well as access control configuration to allow only certain pods to be able to mount those secrets.

When an approved pod's spec references a volume with the same name as a CSISecrets resource, the Vault Secrets Operator CSI driver will populate 
any containers in that pod (that are referencing the volume) with the secrets declared in that CSISecrets resource.

## Features

The following features are supported by the Vault Secrets Operator CSI driver:

- Support for syncing multiple secrets from multiple secret engine mounts
- Automatic generation and mounting of response-wrapped AppRole Secret IDs, allowing the Vault Secrets Operator CSI driver to be a [trusted orchestrator](/vault/tutorials/app-integration/secure-introduction?in=vault%2Fapp-integration#trusted-orchestrator) for credentials to authenticate application pods to Vault
- Support for installation using `Helm`<br />
*see the [installation](/vault/docs/platform/k8s/vso/installation) docs for more details*
- Support for [secret data transformation](/vault/docs/platform/k8s/vso/secret-transformation).

## Supported secret sources

The Vault Secrets Operator CSI driver supports syncing of:
* KV-v1 and KV-v2 secrets
* Secret IDs for the AppRole auth method

## Setup

Running Vault Secrets Operator with the `"csi.enabled=true"` flag deploys the CSI driver as a DaemonSet running on every node.

```shell-session
$ helm install --version 0.10.0 --create-namespace --namespace vault-secrets-operator --set "csi.enabled=true" vault-secrets-operator hashicorp/vault-secrets-operator
```

Like the traditional Vault Secrets Operator, the Vault Secrets Operator CSI driver requires the existence of certain Custom Resources (CRs). The Custom Resource Definitions (CRDs) for these resources are deployed as part of the 
Vault Secrets Operator [Helm chart](/vault/docs/deploy/kubernetes/vso/installation#installation-using-helm). In particular, the [VaultAuth](/vault/docs/deploy/kubernetes/vso/api-reference#vaultauth) and [VaultConnection](/vault/docs/deploy/kubernetes/vso/api-reference#vaultconnection) resources are required to allow the driver to connect to Vault. 
See [Vault authentication in detail](/vault/docs/deploy/kubernetes/vso/sources/vault/auth) for examples of how to set these up.

The Vault Secrets Operator CSI driver also requires the creation of a Custom Resource called a `CSISecrets`, which lists out the secrets that the CSI driver pods will fetch from Vault.

Secrets are repopulated whenever an application container starts or restarts. In the case of AppRole secret IDs, a brand-new secret ID will be generated whenever a requesting container starts up.
The Vault Secrets Operator CSI driver does not yet support responding to update events of secrets in Vault, so application containers will need to manage their own restarts when that happens.

The following example configuration for a CSISecrets resource showcases the ability to fetch multiple secrets from Vault, from multiple mounts, with the assumption that the user has already set up: 
- 2 secrets engines in Vault: a KV-v1 secrets engine at the mount path "kv1", and a KV-v2 secrets engine at the mount path "kv2"
- an AppRole auth method in Vault at the mount path "approle", with a role configured with the name "my-app"
- a VaultAuth resource called `default` in the same Kubernetes namespace as their app, which in turn references a VaultConnection in an administrative namespace

```yaml
apiVersion: secrets.hashicorp.com/v1beta1
kind: CSISecrets
metadata:
  name: my-app-secrets
  namespace: vault-secrets-operator-system
spec:
  vaultAuthRef:
    name: default
  secrets:
    vaultStaticSecrets:
      - mount: kv1
        path: app-api-key
        type: kv-v1
      - mount: kv2
        path: app-api-key
        type: kv-v2
        version: 1 # The version of the KV secret -- if not specified, defaults to the latest version
    vaultAppRoleSecretIDs:
      - role: my-app
        mount: approle
        wrapTTL: "30m"
        ttl: "1h"
        numUses: 2
  accessControl:
    serviceAccountPattern: "default"
    namespacePatterns:
      - "default"
    podNamePatterns:
      - "^my-app-"
  syncConfig:
    containerState:
      namePattern: "^(app|sidecar)$" # Pattern to match authorized container names
```

The full API documentation for the CSISecrets CR can be found at the [API reference](/vault/docs/deploy/kubernetes/vso/api-reference#csisecrets).

## Usage

Once the CSISecrets has been created, application pods matching the patterns specified in the CSISecrets resource's `accessControl` stanza can request to mount volumes containing the secrets declared in the `secrets` stanza.

The CSI driver pod on that application's node will respond to the request, ensuring that the kubelet publishes a volume containing all the secrets in that CSISecrets resource.

Example deployment spec:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
  namespace: default
  labels:
    app.kubernetes.io/component: my-app
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: my-app
  replicas: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/component: my-app
    spec:
      serviceAccountName: default
      containers:
      - name: app
        image: my-app-image:latest
        volumeMounts:
        - name: csi-secrets
          mountPath: /var/run/csi-secrets
      - name: sidecar
        image: my-app-sidecar-image:latest
        volumeMounts:
        - name: csi-secrets
          mountPath: /var/run/csi-secrets
      volumes:
      - name: csi-secrets
        csi:
          driver: csi.vso.hashicorp.com
          volumeAttributes:
            csiSecretsName: my-app-secrets
            csiSecretsNamespace: vault-secrets-operator-system
```

After the pod starts up, all of the secrets from the CSISecrets resource will be found at the configured mount path (in this case, `/var/run/csi-secrets`) as individual files.

The files are indexed with a number representing their position in the CSISecrets `vaultStaticSecrets` or `vaultAppRoleSecretIDs` list, starting at 0.
For example, the first file will be called `static_secret_0_secret`, the second will be `static_secret_1_secret`, etc.

The Kubernetes field [subPath](https://kubernetes.io/docs/concepts/storage/volumes/#using-subpath) can be used to limit which files are available to each container; otherwise, all containers in the pod will have access to all the secrets from the CSISecrets resource.
```yaml
...

      - name: sidecar
        image: my-app-sidecar-image:latest
        volumeMounts:
        - name: csi-secrets
          mountPath: /var/run/app_role_0_wrap_info.json
          subPath: app_role_0_wrap_info.json # Only make this file available to the container, not the others
...
```
