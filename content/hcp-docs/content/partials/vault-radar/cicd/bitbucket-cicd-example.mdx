This is an example Bitbucket pipeline configuration. The configuration will run
the `tip` scan on any change merged into `main` and the `pr` scan on any pull
request.

`HCP_PROJECT_ID`, `HCP_CLIENT_ID`, and `HCP_CLIENT_SECRET` should be available
to the pipeline job as repository variables.

To supply the correct information to the `ci` commands, you need to get additional
information about the pull request using the Bitbucket API.

You need an access token which you can generate by going to **Repository Settings** >
**Access Tokens** from your Bitbucket repository. You can save the token as a
secure repository variable `REPO_ACCESS_TOKEN`.

<Note>

It's important to add the `clone` section with a variable `depth` set to
`full` so the cloned repository has the entire history. Without this, the
results can be inaccurate.

</Note>

<CodeBlockConfig>

```YAML
image: atlassian/default-image:3

pipelines:
  branches:
    'main':
      - step:
          name: 'Run Vault Radar'
          clone:
            depth: full
          script:
            - export LATEST_VERSION=$(curl https://api.releases.hashicorp.com/v1/releases/vault-radar/latest | jq -r .version)
            - curl https://releases.hashicorp.com/vault-radar/${LATEST_VERSION}/vault-radar_${LATEST_VERSION}_linux_amd64.zip -o vr.zip # download latest binary
            - unzip vr.zip -d vr
            - mv vr/vault-radar vault-radar
            - ./vault-radar scan ci tip -s medium -o vault-radar.jsonl -l vault-radar.log --pretty=gha
          artifacts:
            - vault-radar.log
            - vault-radar.jsonl
          
  pull-requests:
    '**':
      - step:
          name: 'Run Vault Radar in PR'
          clone:
            depth: full
          script:
          - export LATEST_VERSION=$(curl https://api.releases.hashicorp.com/v1/releases/vault-radar/latest | jq -r .version)
          - curl https://releases.hashicorp.com/vault-radar/${LATEST_VERSION}/vault-radar_${LATEST_VERSION}_linux_amd64.zip -o vr.zip # download latest binary
          - unzip vr.zip -d vr
          - mv vr/vault-radar vault-radar
          - |
            BITBUCKET_PR_INFO=$(curl "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_FULL_NAME}/pullrequests/${BITBUCKET_PR_ID}" -fsS \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $REPO_ACCESS_TOKEN")
          - COMMIT_HEAD_SHA=$(echo -n $BITBUCKET_PR_INFO | jq -r '.source.commit.hash')
          - BASE_HEAD_SHA=$(echo -n $BITBUCKET_PR_INFO | jq -r '.destination.commit.hash')
          - |
            ./vault-radar scan ci pr \
            --head-ref "${COMMIT_HEAD_SHA}" \
            --base-ref "${BASE_HEAD_SHA}" \
            --ref-name "${BITBUCKET_BRANCH}" \
            -s medium -o vault-radar.jsonl -l vault-radar.log --pretty=gha
          artifacts:
            - vault-radar.log
            - vault-radar.jsonl
```

</CodeBlockConfig>

For Bitbucket server instances, the API used to retrieve the PR details needs to changed to something like so:

```bash

BITBUCKET_PR_INFO=$(curl "https://<SERVER DOMAIN>/rest/api/latest/projects/${BITBUCKET_PROJECT_KEY}/repos/${BITBUCKET_REPO_FULL_NAME}/pull-requests/${BITBUCKET_PR_ID}" -fsS \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $REPO_ACCESS_TOKEN")

```
[Bitbucket server API reference](https://developer.atlassian.com/server/bitbucket/rest/v910/api-group-pull-requests/#api-api-latest-projects-projectkey-repos-repositoryslug-pull-requests-pullrequestid-get)