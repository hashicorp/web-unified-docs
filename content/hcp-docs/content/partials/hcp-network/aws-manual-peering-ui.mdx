### Initiate peering connection

1. Click **HashiCorp Virtual Network** in the left navigation menu.

1. Select the HVN you want to create a peering connection with.

1. In the selected HVN overview page, click **Peering connections**.

   If you have peering connections available, they are listed in the center of the screen.

1. Click **Create connection**.

1. Select the **Manual peering using HCP and AWS web console** radio button.

   <Note>

   If you are unsure of where to find the AWS Account ID or the VPC ID, click on the link labeled **Where can I find this?**. The link provides helpful information and a screenshot of where in the AWS Console this information can be found.

   </Note>

### Accept the peering connection

The newly created peering connection is in _pending_ state. You can accept the connection using the AWS Console.

1. Launch the [Amazon VPC Console](https://console.aws.amazon.com/vpc/), and select **Peering Connections** from the left navigation menu. You should have an entry in the list with a status of **pending acceptance**.

   <Note>

   It may take a few minutes before the peering connection is available and visible.

   </Note>

1. Click on **Actions**, then select **Accept request**.

1. A popup will appear on the screen. Accept the connection in order to establish the peering connection between the VPC and the HashiCorp Cloud Platform (HCP).

   <Note>

   Additional information regarding AWS peering connections can be found in the AWS [documentation](https://docs.aws.amazon.com/vpc/latest/peering/create-vpc-peering-connection.html#accept-vpc-peering-connection).

   </Note>

1. Return to [the HCP Portal](https://portal.cloud.hashicorp.com/) and wait for the stepper to move to the **Configure** step before proceeding.

### Update security groups

Update the relevant [security
groups](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)
in the target VPC by adding the following rules allowing ingress and egress for
the CIDR block of HVN. These rules are valid for applications that are accessing
your cluster (DNS and API) via localhost, but your configuration might need to
differ.

Select the security group associated with your VPC, and add the following
inbound and outbound rules.

**NOTE:** Also, refer to the [AWS official
documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/working-with-security-groups.html#updating-security-group-rules)
or [the HCP Portal](https://portal.cloud.hashicorp.com/) help instruction.

<Tabs>
<Tab heading="HCP Vault Dedicated" group="vault">

HCP Vault Dedicated requires an outbound (egress) rule to permit traffic from the AWS resources. By default, AWS permits all outbound traffic from
a security group. However, if you have removed this rule, or use Terraform to manage AWS security groups, you will need to add a rule to
permit Vault traffic.

Vault Dedicated requires inbound (ingress) rule(s) if you intend to use Vault to fulfill workflows, or interact with services in your environment.

Examples workflows may include, but may not be limited to:

- Dynamic credential workflows such as generating database credentials or Kubernetes service accounts
- Authorization workflows such as utilizing self-managed LDAP services or other IDPs under your control

#### Outbound (Egress)

The table below documents the egress configuration that must be applied to
the security group.

| Protocol | From Port | To Port | Destination |  Purpose  |
| -------- | :-------: | :-----: | :---------: | :-------: |
| TCP      |   8200    |  8200   |  HVN-CIDR   | Vault API |
| TCP      |   5696    |  5696   |  HVN-CIDR   | KMIP      |

1. From the AWS VPC console, select **Security groups** from the left navigation menu.

1. Click the security group you wish to update and click the **Outbound rules** tab.

1. Click **Edit outbound rules**.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom TCP**.

1. Enter `8200` in the **Port range** textbox.

1. Enter the CIDR block for your HVN in the **Destination** textbox.

1. Click **Add rule** again.

1. Set the **Type** pulldown menu to **Custom TCP**.

1. Enter `5696` in the **Port range** textbox.

1. Enter the CIDR block for your HVN in the **Destination** textbox.

1. Click **Save rules**.

</Tab>
<Tab heading="HCP Consul Dedicated" group="consul">

HCP Consul Dedicated requires both inbound (ingress) and outbound (egress) rules to permit traffic from the AWS resources. By default, AWS permits all outbound traffic from
a security group. However, if you have removed this rule, or use Terraform to manage AWS security groups, you will need to add a rule to
permit outbound traffic for Consul.

#### Inbound (Ingress)

The table below documents the ingress configuration that must be applied to the
security group.

| Protocol | From Port | To Port |          Source          |                 Description                 |
| -------- | :-------: | :-----: | :----------------------: | :-----------------------------------------: |
| TCP      |   8301    |  8301   |         HVN-CIDR         |      Used to handle gossip from server      |
| UDP      |   8301    |  8301   |         HVN-CIDR         |      Used to handle gossip from server      |
| TCP      |   8301    |  8301   | Security group ID itself | Used to handle gossip between client agents |
| UDP      |   8301    |  8301   | Security group ID itself | Used to handle gossip between client agents |


1. From the AWS VPC console, select **Security groups** from the left navigation menu.

1. Click the security group you wish to update and click the **Inbound rules** tab.

1. Click **Edit inbound rules**.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom TCP**.

1. Enter `8301` in the **Port range** textbox.

1. Enter the CIDR range for your HVN in the **Source** textbox.

1. Repeat the steps above selecting **Custom UDP** for the **Type** pulldown menu.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom TCP**.

1. Enter `8301` in the **Port range** textbox.

1. Enter the security group ID in the **Source** textbox.

1. Repeat the steps above selecting **Custom UDP** for the **Type** pulldown menu.

#### Outbound (Egress)

The table below documents the egress configuration that must be applied to
the security group.

| Protocol | From Port | To Port |       Destination        |                 Description                 |
| -------- | :-------: | :-----: | :----------------------: | :-----------------------------------------: |
| TCP      |   8300    |  8300   |         HVN-CIDR         |      Used by clients to talk to server      |
| TCP      |   8301    |  8301   |         HVN-CIDR         |         Used to gossip with server          |
| UDP      |   8301    |  8301   |         HVN-CIDR         |         Used to gossip with server          |
| TCP      |   8301    |  8301   | Security group ID itself | Used to handle gossip between client agents |
| UDP      |   8301    |  8301   | Security group ID itself | Used to handle gossip between client agents |
| TCP      |    80     |   80    |         HVN-CIDR         |                 Consul API                  |
| TCP      |    443    |   443   |         HVN-CIDR         |                 Consul API                  |
| TCP      |   8502    |  8502   |         HVN-CIDR         | Consul Dataplane communication with server  |

1. Click the **Outbound rules** tab.

1. Click **Edit outbound rules**.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom TCP**.

1. Enter `8300-8301` in the **Port range** textbox.

1. Enter the CIDR block for your HVN in the **Destination** textbox.

1. Repeat the steps above, create a new rule for TCP ports `80`, `443`, and `8502`.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom TCP**.

1. Enter `8301` in the **Port range** textbox.

1. Enter the security group ID in the **Source** textbox.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom UDP**.

1. Enter `8301` in the **Port range** textbox.

1. Enter the CIDR block for your HVN in the **Source** textbox.

1. Click **Add rule**.

1. Set the **Type** pulldown menu to **Custom UDP**.

1. Enter `8301` in the **Port range** textbox.

1. Enter the security group ID in the **Source** textbox.

1. Click **Save rules**.

</Tab>
</Tabs>

### Update AWS route table

For compute resources to take advantage of the logical network path enabled by the peering connection, a network route must be added to the VPC's routing table.
The route table entry directs compute resources to the HashiCorp Cloud Platform (HCP) network. Without a route entry in the VPC's route table, those compute resources cannot connect to HashiCorp Cloud Platform (HCP) resources.

1. In the [Amazon VPC console](https://console.aws.amazon.com/vpc/), select **Route Tables** from the left sidebar. If you have multiple VPCs, verify that the VPC used to establish the peering connection is selected.

1. Click **Actions** and select **Edit Routes**.

1. Click **Add route**.

1. Enter the CIDR block for your HVN in the **Destination** textbox.

1. Type `pcx-` in the **Target** textbox and select the peering connection ID for the HVN.

The manual peering process is now complete.