---
page_title: Bitbucket Pipelines
description: Learn how to integrate Bitbucket Pipelines with HashiCorp Vault for secure secrets management.
---

# Bitbucket Pipelines

Bitbucket Pipelines supports OpenID Connect (OIDC) tokens that provide secure authentication to Vault without storing long-lived credentials. When you use OIDC authentication, Bitbucket generates a short-lived identity token for each pipeline step that Vault can verify using the [JWT auth method](/vault/docs/auth/jwt) and use to grant access to secrets.

## Why

Managing secrets in Bitbucket Pipelines presents several challenges:

**Secret sprawl across repositories and workspaces:** Teams often duplicate secrets across multiple Bitbucket repositories, deployment environments, and workspace-level variables, making rotation difficult and increasing the risk of exposure if a single repository is compromised.

**Limited repository variable protection:** Bitbucket's built-in repository and deployment variables provide basic secret storage with masking in logs, but lack advanced features like automatic rotation, dynamic secret generation, and centralized policy management across multiple Bitbucket workspaces.

**Compliance and audit requirements:** Organizations need detailed audit trails showing which pipelines accessed which secrets and when, but Bitbucket's native logging may not provide the granularity required for regulatory compliance frameworks like SOC 2, PCI DSS, and HIPAA.

**No dynamic credential support:** Static secrets stored in Bitbucket variables remain valid indefinitely, creating a larger attack surface compared to short-lived dynamic credentials that expire automatically.

Integrating Vault with Bitbucket Pipelines addresses these challenges by centralizing secrets management, enabling dynamic secret generation, providing comprehensive audit logs, and supporting automatic credential rotation.

## Prerequisites

Before integrating Bitbucket Pipelines with Vault, you need the following:

- A Vault instance accessible from Bitbucket Pipelines runners over the network (or use HCP Vault)
- Bitbucket workspace with admin access to configure OIDC identity providers and pipeline settings
- A Vault authentication method configured (JWT/OIDC recommended for Bitbucket)
- Vault policies that grant Bitbucket the necessary read permissions for your secrets
- For production: TLS encryption between Bitbucket Pipelines and Vault

Refer to [Available authentication methods](/vault/docs/auth) for Vault auth method options.

## Use OIDC authentication

Bitbucket Pipelines can generate OIDC tokens for each pipeline step, providing secure authentication to Vault without storing long-lived credentials. Follow the [Bitbucket OIDC documentation](https://support.atlassian.com/bitbucket-cloud/docs/integrate-pipelines-with-resource-servers-using-oidc/) to enable OIDC tokens for your repository.

This approach provides several benefits:

- No static credentials stored in Bitbucket
- Automatic token rotation with each pipeline run
- Fine-grained access control based on repository, workspace, and deployment environment
- Comprehensive audit trail in Vault logs

### Configure Vault JWT auth

Configure Vault's JWT auth method to accept Bitbucket OIDC tokens. Create a role that maps Bitbucket claims to Vault policies:

```bash
vault write auth/jwt/config \
  oidc_discovery_url="https://api.bitbucket.org/2.0/workspaces/YOUR_WORKSPACE/pipelines-config/identity/oidc" \
  bound_issuer="https://api.bitbucket.org/2.0/workspaces/YOUR_WORKSPACE/pipelines-config/identity/oidc"

vault write auth/jwt/role/bitbucket-role \
  role_type="jwt" \
  bound_audiences="ari:cloud:bitbucket::workspace/YOUR_WORKSPACE_UUID" \
  bound_claims_type="glob" \
  bound_claims='{"repositoryUuid":"{YOUR_REPO_UUID}"}' \
  user_claim="sub" \
  policies="bitbucket-policy" \
  ttl=1h
```

This configuration establishes trust between Vault and Bitbucket by specifying the OIDC discovery URL and creating a role that restricts access to tokens from your specific Bitbucket workspace and repository.

### Retrieve secrets in pipelines

Configure your Bitbucket pipeline to authenticate with Vault using OIDC and retrieve secrets:

```yaml
image: atlassian/default-image:4

pipelines:
  default:
    - step:
        name: Deploy with Vault secrets
        oidc: true
        script:
          # Install Vault CLI
          - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          - sudo apt update && sudo apt install vault jq -y

          # Authenticate to Vault with OIDC token
          - export VAULT_ADDR="https://vault.example.com:8200"
          - export VAULT_TOKEN=$(vault write -field=token auth/jwt/login
              role=bitbucket-role
              jwt=$BITBUCKET_STEP_OIDC_TOKEN)

          # Retrieve secrets from Vault
          - export DB_PASSWORD=$(vault kv get -field=password secret/database/production)
          - export API_KEY=$(vault kv get -field=key secret/api/production)

          # Use secrets in deployment
          - ./deploy.sh
```

This pipeline uses OIDC for the step with `oidc: true`, authenticates to Vault using Bitbucket's automatically generated OIDC token (`$BITBUCKET_STEP_OIDC_TOKEN`), and retrieves secrets from Vault's KV secrets engine for use in the deployment process.

## Verify the integration

After configuring Bitbucket Pipelines to retrieve secrets from Vault, verify the integration works correctly:

1. **Run a test pipeline:** Create a simple pipeline that retrieves a test secret from Vault and uses it in a script. Confirm the secret is not visible in Bitbucket pipeline logs.
1. **Check Vault audit logs:** Verify that Vault audit logs show successful authentication from Bitbucket and secret reads at the expected paths.
1. **Test secret rotation:** If using dynamic secrets, verify that Vault generates new credentials on each pipeline run and that old credentials are revoked after the configured TTL.
1. **Validate least-privilege access:** Confirm that Bitbucket can only access secrets permitted by its Vault policy and cannot read secrets outside its scope.

## Production readiness

Before deploying your Vault integration to production, verify the following:

- **High availability:** Use a Vault cluster with multiple nodes or [HCP Vault Dedicated](/hcp/docs/vault) for automatic HA
- **Monitoring:** Configure [Vault telemetry](/vault/docs/internals/telemetry/enable-telemetry) to alert on seal status, authentication failures, and secret access anomalies
- **Audit logging:** Enable at least one [Vault audit device](/vault/docs/audit) for compliance and security investigations
- **Secret rotation:** Implement automated rotation for static secrets and appropriate TTLs for dynamic secrets
- **Disaster recovery:** Document and test your Vault recovery procedures, including unseal processes and backup restoration
- **Network security:** Ensure TLS encryption for all Vault communication and restrict network access to authorized CI/CD runners

Review the [Vault production hardening guide](/vault/tutorials/vault/production-hardening) for comprehensive production deployment recommendations.

## HashiCorp resources

CI/CD secrets overview:

- [CI/CD secrets overview](/well-architected-framework/secure-systems/secure-applications/ci-cd-secrets)
- [Dynamic and static secrets in CI/CD](/well-architected-framework/secure-systems/secure-applications/ci-cd-secrets/dynamic-and-static-secrets)
- [CI/CD secrets anti-patterns](/well-architected-framework/secure-systems/secure-applications/ci-cd-secrets/anti-patterns)

Vault authentication for CI/CD:

- Read the [Vault authentication methods documentation](/vault/docs/auth) for an overview of available auth methods
- Learn about [JWT/OIDC auth method](/vault/docs/auth/jwt) for token-based pipeline authentication
- Complete the [OIDC auth method tutorial](/vault/tutorials/auth-methods/oidc-auth) to understand OIDC authentication patterns

Vault secrets and dynamic credentials:

- Understand [dynamic and static secrets](/vault/tutorials/get-started/understand-static-dynamic-secrets) to choose the right approach for your pipelines
- Read the [KV secrets engine documentation](/vault/docs/secrets/kv) for static secret storage
- Learn about [AWS secrets engine](/vault/docs/secrets/aws) for dynamic cloud credentials
- Explore [database secrets engine](/vault/docs/secrets/databases) for dynamic database credentials

### External resources

- Read the [Bitbucket Pipelines OIDC documentation](https://support.atlassian.com/bitbucket-cloud/docs/integrate-pipelines-with-resource-servers-using-oidc/) for token configuration and identity provider setup
- Review the [Bitbucket Pipelines configuration reference](https://support.atlassian.com/bitbucket-cloud/docs/bitbucket-pipelines-configuration-reference/) for pipeline YAML syntax
- Learn about [Bitbucket deployment environments](https://support.atlassian.com/bitbucket-cloud/docs/set-up-and-monitor-deployments/) for environment-scoped variable management

## Next steps

In this section of [managing CI/CD secrets](/well-architected-framework/secure-systems/secure-applications/ci-cd-secrets), you learned about Bitbucket Pipelines and Vault integration. Bitbucket Pipelines and Vault integration is part of the [Secure systems pillar](/well-architected-framework/secure-systems).
