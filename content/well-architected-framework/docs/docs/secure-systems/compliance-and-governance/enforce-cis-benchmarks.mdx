---
page_title: Enforce CIS benchmarks
description: Automate CIS benchmark enforcement with Packer and Terraform to build hardened images and deploy compliant infrastructure for NIST 800-53, HIPAA, and PCI-DSS.
---

# Enforce CIS Benchmarks

The Center for Internet Security [(CIS) Benchmarks](https://www.cisecurity.org/cis-benchmarks) provide detailed security configuration guidelines for operating systems, cloud platforms, and applications. Organizations adopt CIS benchmarks to meet compliance requirements like NIST 800-53, HIPAA, SOC 2, and PCI-DSS. Manual implementation creates inconsistencies across environments and makes auditing time-consuming.

You can automate CIS benchmark enforcement by building security baselines into machine images with Packer and applying configurations at deployment with Terraform. Packer hardens operating systems during the image build process, ensuring every instance starts from a compliant baseline. Terraform applies infrastructure-level security controls like encryption, monitoring, and network policies when you deploy resources.

Automated enforcement reduces security misconfigurations, accelerates compliance audits, and eliminates configuration drift across environments.

## Why enforce CIS benchmarks

**Manual configuration creates inconsistencies:** SSH is configured to disable root login on the production web servers but permits it on three staging instances that got rebuilt last month. The dev environment uses different filesystem hardening rules because someone copied an older configuration template. Verifying compliance across NIST 800-53, HIPAA, and PCI-DSS requires checking each system individually.

**Compliance audits consume weeks of effort:** SOC 2 audits require screenshots of SSH configurations from every production server. Auditors want proof that log permissions stayed locked down for the entire audit period, not just today. When you have 300 servers, manual documentation means logging into each one and running commands by hand.

**Configuration drift introduces security gaps:** A system administrator SSH'd into a server at 2am to troubleshoot an incident, modified `/etc/ssh/sshd_config` to allow password auth temporarily, and forgot to revert it. Another admin installed a debugging tool that created new filesystem mounts without the proper permissions. Manual changes like these accumulate across infrastructure without anyone tracking them.

**Inconsistent security baselines expose systems:** Production uses CIS Level 2 controls while staging runs Level 1 because "it's just for testing." The platform team interprets "disable unnecessary filesystems" to mean cramfs and freevxfs. The security team's checklist includes hfs and hfsplus. Nobody realizes the discrepancy until an audit.

Automating CIS benchmark enforcement means baking security controls into machine images with Packer and applying infrastructure settings with Terraform. Every instance starts from the same hardened baseline. Configuration is code that gets reviewed, versioned, and audited like any other infrastructure change.

## How CIS benchmarks work

CIS benchmarks define two implementation levels. Level 1 includes essential security controls that apply to most environments with minimal operational impact. Level 2 adds stricter controls for high-security environments that may affect system capabilities or performance.

Each benchmark provides specific configuration recommendations organized by category like filesystem permissions, network settings, logging, and access controls. Organizations select the appropriate level based on security requirements and operational constraints. For complete benchmark details, refer to the [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks) documentation.

## Build security into golden images

Packer builds an AMI with filesystem hardening, secure logging, SSH restrictions, and file integrity monitoring. The Packer build produces an AMI tagged with CIS compliance metadata. Terraform queries this AMI using data sources to deploy compliant instances, ensuring your infrastructure uses hardened images without manual AMI ID updates.

The build process applies security controls before any application code runs. Security baselines live in version control separate from application code. You can test image hardening changes independently and roll them out without touching application deployments.

The following Packer configuration builds a hardened Ubuntu image with CIS Level 1 controls:

```hcl
packer {
  required_plugins {
    amazon = {
      source  = "github.com/hashicorp/amazon"
      version = "~> 1"
    }
  }
}

source "amazon-ebs" "ubuntu_cis" {
  ami_name      = "ubuntu-22-04-cis-level1-{{timestamp}}"
  instance_type = "t3.micro"
  region        = "us-west-2"
  source_ami_filter {
    filters = {
      name                = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
      root-device-type    = "ebs"
      virtualization-type = "hvm"
    }
    owners      = ["099720109477"]
    most_recent = true
  }
  ssh_username = "ubuntu"
  tags = {
    Name       = "Ubuntu 22.04 CIS Level 1"
    CIS_Level  = "1"
    Compliance = "CIS"
    Built_With = "Packer"
  }
}

build {
  sources = ["source.amazon-ebs.ubuntu_cis"]

  # Apply CIS filesystem hardening
  provisioner "shell" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get install -y aide aide-common",
      "sudo aideinit",
      # Disable unnecessary filesystems
      "echo 'install cramfs /bin/true' | sudo tee -a /etc/modprobe.d/CIS.conf",
      "echo 'install freevxfs /bin/true' | sudo tee -a /etc/modprobe.d/CIS.conf",
      "echo 'install jffs2 /bin/true' | sudo tee -a /etc/modprobe.d/CIS.conf",
      "echo 'install hfs /bin/true' | sudo tee -a /etc/modprobe.d/CIS.conf",
      "echo 'install hfsplus /bin/true' | sudo tee -a /etc/modprobe.d/CIS.conf",
      "echo 'install udf /bin/true' | sudo tee -a /etc/modprobe.d/CIS.conf",
    ]
  }

  # Configure secure logging
  provisioner "shell" {
    inline = [
      "sudo apt-get install -y rsyslog",
      "sudo systemctl enable rsyslog",
      "sudo systemctl start rsyslog",
      # Configure log file permissions
      "sudo chmod -R g-wx,o-rwx /var/log/*",
    ]
  }

  # Harden SSH configuration
  provisioner "shell" {
    inline = [
      "sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config",
      "sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config",
      "sudo sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords no/' /etc/ssh/sshd_config",
      "sudo sed -i 's/#MaxAuthTries 6/MaxAuthTries 4/' /etc/ssh/sshd_config",
      "echo 'ClientAliveInterval 300' | sudo tee -a /etc/ssh/sshd_config",
      "echo 'ClientAliveCountMax 0' | sudo tee -a /etc/ssh/sshd_config",
    ]
  }

  # Enable automatic security updates
  provisioner "shell" {
    inline = [
      "sudo apt-get install -y unattended-upgrades",
      "sudo dpkg-reconfigure -plow unattended-upgrades",
    ]
  }

  # Set file integrity monitoring
  provisioner "shell" {
    inline = [
      "sudo systemctl enable aide.timer",
    ]
  }
}
```

## Apply security configurations at deployment

You use Terraform to implement CIS benchmark requirements at the infrastructure level when you deploy resources. Configure encryption, monitoring, network policies, and access controls in your Terraform code to complement the operating system hardening built into your machine images.

The following Terraform configuration deploys a CIS-compliant EC2 instance with required security controls:

```hcl
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "us-west-2"
}

# Input variables
variable "vpc_id" {
  description = "The VPC ID where the security group will be created"
  type        = string
}

variable "allowed_cidr_blocks" {
  description = "List of CIDR blocks allowed to access the instance on port 443"
  type        = list(string)
  default     = []
}

variable "subnet_id" {
  description = "The subnet ID where the EC2 instance will be launched"
  type        = string
}

# Query the most recent CIS-hardened AMI
data "aws_ami" "cis_ubuntu" {
  most_recent = true
  owners      = ["self"]

  filter {
    name   = "name"
    values = ["ubuntu-22-04-cis-level1-*"]
  }

  filter {
    name   = "tag:CIS_Level"
    values = ["1"]
  }
}

# Create security group with restricted access
resource "aws_security_group" "cis_compliant" {
  name        = "cis-compliant-sg"
  description = "CIS-compliant security group with restricted access"
  vpc_id      = var.vpc_id

  # Allow only necessary inbound traffic
  ingress {
    description = "HTTPS from approved networks"
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = var.allowed_cidr_blocks
  }

  # Allow all outbound traffic
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name       = "CIS Compliant Security Group"
    Compliance = "CIS"
  }
}

# Deploy instance with encrypted EBS volumes
resource "aws_instance" "cis_server" {
  ami                    = data.aws_ami.cis_ubuntu.id
  instance_type          = "t3.micro"
  vpc_security_group_ids = [aws_security_group.cis_compliant.id]
  subnet_id              = var.subnet_id
  monitoring             = true # Enable detailed CloudWatch monitoring
  iam_instance_profile   = aws_iam_instance_profile.cis_profile.name

  metadata_options {
    http_endpoint               = "enabled"
    http_tokens                 = "required" # Require IMDSv2
    http_put_response_hop_limit = 1
  }

  root_block_device {
    encrypted   = true
    kms_key_id  = aws_kms_key.ebs_key.arn
    volume_type = "gp3"
    volume_size = 20
  }

  tags = {
    Name            = "CIS Compliant Server"
    Compliance      = "CIS"
    Backup_Required = "true"
  }
}

# Create KMS key for EBS encryption
resource "aws_kms_key" "ebs_key" {
  description             = "KMS key for EBS volume encryption"
  deletion_window_in_days = 10
  enable_key_rotation     = true

  tags = {
    Name       = "EBS Encryption Key"
    Compliance = "CIS"
  }
}

# Create IAM role for CloudWatch logging
resource "aws_iam_role" "cis_role" {
  name = "cis-compliant-instance-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "cloudwatch_logs" {
  role       = aws_iam_role.cis_role.name
  policy_arn = "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
}

resource "aws_iam_instance_profile" "cis_profile" {
  name = "cis-compliant-profile"
  role = aws_iam_role.cis_role.name
}

# Enable CloudWatch log group for instance logs
resource "aws_cloudwatch_log_group" "instance_logs" {
  name              = "/aws/ec2/cis-compliant"
  retention_in_days = 90

  tags = {
    Name       = "CIS Instance Logs"
    Compliance = "CIS"
  }
}
```

Terraform uses a data source to query the latest CIS-hardened AMI built by Packer. No hard-coded AMI IDs to update. The configuration enforces encrypted EBS volumes with KMS, restricts network access through security groups, requires IMDSv2 for metadata access, and enables detailed monitoring with CloudWatch.

Running `terraform apply` creates infrastructure that meets CIS benchmark requirements for encryption, logging, and access control. Terraform state files become your audit evidence. When auditors ask "show me that all production volumes are encrypted," you point them at the encrypted = true lines in version control and the resources in state. Infrastructure changes go through pull request review before anyone runs them in production.

## HashiCorp resources

**Get started with automation tools:**

- Follow the [Terraform AWS Get Started tutorials](/terraform/tutorials/aws-get-started)
  to deploy your first infrastructure and understand core Terraform workflows
- Complete the [Packer AWS Get Started tutorials](/packer/tutorials/aws-get-started)
  to build your first machine image with security hardening
- Read the [Terraform documentation](/terraform/docs) to understand state management,
  providers, and resource configuration
- Explore the [Packer documentation](/packer/docs) to learn about provisioners,
  builders, and post-processors

**Build security compliance workflows:**

- Use [HCP Terraform](/terraform/cloud-docs) for team collaboration, remote state
  management, and policy enforcement with Sentinel
- Configure [Terraform state](/terraform/language/state) to track infrastructure
  configurations and maintain compliance audit trails
- Review the [Terraform AWS provider documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
  for detailed resource configuration options and security settings

**Create hardened machine images:**

- Learn about [Packer provisioners](/packer/docs/provisioners) to configure operating
  systems during image builds with shell scripts, Ansible, or Chef
- Read the [Packer Amazon EBS builder documentation](/packer/plugins/builders/amazon/ebs)
  to understand AMI creation options, instance configuration, and tagging strategies
- Explore [HCP Packer](/hcp/docs/packer) to version and track machine images across
  your organization with automated compliance validation

**Enforce security policies:**

- Learn how to [implement policy as code](/well-architected-framework/secure-systems/compliance-and-governance/policy-as-code)
  to validate that infrastructure changes meet CIS requirements before deployment
- Review [immutable infrastructure patterns](/well-architected-framework/secure-systems/infrastructure-reliability/immutable-infrastructure)
  to prevent configuration drift by replacing instances rather than modifying them
- Implement [Sentinel policy as code](/sentinel/docs) to validate infrastructure
  changes before deployment and enforce CIS benchmark compliance
- Learn the [Sentinel language syntax](/sentinel/docs/language) to write custom
  policies that check encryption, network rules, and access controls
- Review [Terraform Cloud policy enforcement](/terraform/cloud-docs/policy-enforcement)
  to understand policy sets, enforcement levels, and compliance reporting

## External resources

- [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks) for security configuration standards
- [NIST 800-53 Security Controls](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final) for federal security control catalog
- [AWS CIS Foundations Benchmark](https://docs.aws.amazon.com/securityhub/latest/userguide/cis-aws-foundations-benchmark.html) for AWS-specific controls
- [Azure CIS Benchmark](https://learn.microsoft.com/en-us/azure/governance/policy/samples/cis-azure-1-4-0) for Azure security baseline
- [GCP CIS Benchmark](https://cloud.google.com/security/compliance/cis-benchmark) for Google Cloud security standards

## Next steps

Hardened machine images and infrastructure-as-code give you consistent security baselines. The next step is catching violations before they reach production.

Implement [policy as code](/well-architected-framework/security/policy-as-code) with Sentinel to block Terraform changes that would deploy unencrypted volumes or create security groups with unrestricted ingress. Use [immutable infrastructure](/well-architected-framework/security/immutable-infrastructure) to eliminate configuration drift by replacing instances instead of patching them in place. Learn about [secrets management](/well-architected-framework/security/secrets-management) with Vault to avoid hardcoding database passwords or API keys in your Packer scripts.
