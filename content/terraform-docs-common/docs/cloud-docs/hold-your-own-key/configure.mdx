---
page_title: Configure and manage keys
description: >-
  Learn how to set up hold your own key encryption for HCP Terraform, letting you secure your sensitive data in state and plan files using a key from an external key management system.
tfc_only: true
---

# Configure and manage keys

Configure your KMS and HCP Terraform before you use hold your own key (HYOK) to
encrypt your sensitive artifacts.

## Background

HCP Terraform allows you to configure multiple HYOK configurations in your
organization settings. Each HYOK configuration corresponds to a single key in a
KMS. Other HYOK configurations could point to different keys in the same KMS, or
keys in multiple KMSs.

A single HYOK configuration is marked as your organization's **primary**
configuration. When you enable HYOK on a workspace, its artifacts are
automatically secured with the key specified in the primary configuration.

## Requirements

To get started using the Hold Your Own Key (HYOK) feature, there are a few steps
you will need to take prior to creating your first HYOK configuration and
enabling HYOK for your workspaces.

- Ensure your organization is on the Premium Tier, as HYOK is only supported for
  Premium Tier organizations.
- Ensure your organization has at least one agent pool hosted with request
  forwarding enabled. The minimum agent version for HYOK is 1.23.0.
- Ensure you have a KMS configured with healthy key management policies to
  prevent data loss. If keys are deleted from a KMS while in use by HCP
  Terraform, this can result in state loss.
- Ensure your workspaces are configured to use Terraform 1.3+.

## Create key configuration

To configure your HCP Terraform organization to use hold your own key, first
configure your key management system to accept the necessary OpenID Connect
(OIDC) requests from HCP Terraform. Then, set up your keys and grant the
necessary roles and permissions in your cloud provider.

<Tabs>
<Tab heading="Azure" group="azure">

To use Azure with HYOK, you need to configure the following:

- A Key Vault and encryption key. 
- An Entra ID Application which trusts the OIDC credentials issued by HCP
  Terraform.
- A service principle in the application with permission to use your Key.

### Create a Key Vault and an ecryption key.

Start by creating a Key Vault and Key to secure your sensitive HCP Terraform
artifacts:

If you do not already have one, [create a Key Vault using the Azure
porta](https://learn.microsoft.com/en-us/azure/key-vault/general/quick-create-portal).
Then, [add a key to the Key
Vault](https://learn.microsoft.com/en-us/azure/key-vault/keys/quick-create-portal#add-a-key-to-key-vault)
to use to secure your sensitive Terraform artifacts.

Take note of the key URI, which will be in the format: `https://<key vault
name>.vault.azure.net/keys/<key name>`. You will use this URI later to configure
your key in HCP Terraform.

### Create an Entra ID Application

Next, follow the steps to [create the Application and Service
Principal](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_oidc#creating-the-application-and-service-principal).
Do not proceed to the "Configure Microsoft Entra ID Application to Trust a
GitHub Repository" step, and set your Application Redirect URI type to `Web`.
Also, take note of the `client_id` and `tenant_id` for your application. You
will use these values to configure your key in HCP Terraform.

### Configure Entra ID to Trust HCP Terraform

Next, create federated identity credentials in your application, which validate
the contents of the token sent to Azure from HCP Terraform.

Follow the steps in the AzureRM provider docs: [Configure Azure Microsoft Entra
ID Application to Trust a Generic
Issuer](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_oidc#configure-azure-active-directory-application-to-trust-a-generic-issuer),
and use the values below when you add a credential.

Specify the following information in the Add a credential step:

- Federated credential scenario: Set to `Other issuer`.
- Issuer: The address of HCP Terraform, `https://app.terraform.io`.
- Subject identifier: The subject identifier from HCP Terraform that this
credential will match. This will be in the form `organization:<your org
name>:hyok_config:<your hyok config name>`. The HYOK configuration name can
contain letters, numbers, hyphens, and underscores.
- Audience: Leave this as the default value, `api://AzureADTokenExchange`.

Make a note of the HYOK config name you choose here, as you will use it later
when you configure HCP Terraform.

</Tab>
<Tab heading="AWS" group="aws">

To use AWS with HYOK, you need to configure the following:
- An OIDC Identity Provider for HCP Terraform.
- An IAM role, with a trust policy which allows it to be assumed by the HCP
Terraform agent.
- An AWS KMS key, which your IAM role can use.

### Create an OIDC Identity Provider

Follow the steps for [Creating OpenID Connect (OIDC) identity providers - AWS
Identity and Access
Management](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html)
through the AWS console or API.

Set your provider URL to the address of HCP Terraform
(`https://app.terraform.io`), and the audience to `aws.workload.identity`

### Create an IAM Role and Trust Policy

Next, configure a role and corresponding trust policy by following: [Creating a
role for web identity or OpenID Connect Federation (console) - AWS Identity and
Access
Management](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html).

Use the following trust policy as a template:

```json
{
   "Version": "2012-10-17",
   "Statement": [
       {
           "Effect": "Allow",
           "Principal": {
               "Federated": "<the ARN of your new Identity Provider>"
           },
           "Action": "sts:AssumeRoleWithWebIdentity",
           "Condition": {
               "StringEquals": {
                   "app.terraform.io:aud": "aws.workload.identity"
               },
               "StringLike": {
                   "app.terraform.io:sub": "organization:<your organization name>:hyok_config:<your hyok config name>"

               }
           }
       }
   ]
}
```

The “Condition” field will match against the subject claim of HCP Terraform's
JWT. For HYOK, the subject claim will be: `organization:<your organization
name>:hyok_config:<your hyok config name>`.

Wildcards are allowed when matching claims. For example, if you want to use the
same role for all keys within your HCP Terraform organization, you can configure
your subject claim to match all HYOK configurations in your organization:
`organization:<your organization name>:hyok_config:*`.

For additional security we recommend that you choose a configuration name now,
so that only the specified HYOK configuration may assume this role.
`organization:<your organization name>:hyok_config:<your hyok config name>`. The
hyok configuration name can contain letters, numbers, hyphens, and underscores.
You will use this hyok configuration name when you configure it in HCP
Terraform.

<Note>

At this time, you must enter this as a "Custom Trust Policy" rather than using
the "Web Identity" trusted entity type. We are working with AWS to improve this
experience.

</Note>

### Create an AWS KMS Key

You must choose or create a symmetric AWS KMS key to use to encrypt and decrypt
your data encryption keys. Use the AWS console or API and the steps in [Create a
symmetric encryption KMS key](https://docs.aws.amazon.com/kms/latest/developerguide/create-symmetric-cmk.html).

Add the IAM role you created in the previous step as a key user, so that the HCP
Terraform agent can use it to perform cryptographic operations.

</Tab>

<Tab heading="GCP" group="gcp">

To use GCP with HYOK, you need to configure the following:

- A key ring and a key to encrypt your sensitive HCP Teraform artifacts.
- A Workload Identity Pool and Provider configured to trust OIDC tokens issued
  by HCP Terraform.
- A service account which can be assumed with the workload identity provider and
  has permission to use the key.

### Create a Key Ring and Key

To begin, [Create a key ring](https://cloud.google.com/kms/docs/create-key-ring)
and a [Create a symmetric encryption
key](https://cloud.google.com/kms/docs/create-key#create-symmetric) in Google
Cloud KMS.

Make a note of the **key name** and the **key ring name**. You will use these values
later when you create your HYOK configuration in HCP Terraform.

### Create a Service Account

Next, [create a service
account](https://cloud.google.com/iam/docs/service-accounts-create) with
permissions to encrypt and decrypt with the key you created. The HCP Terraform
Agent will assume the role of this service account in order to use this key to
encrypt and decrypt your data encryption keys.

Ensure that you grant the service account the necessary IAM permissions to
encrypt and decrypt data using your key. For example, you could use the `Cloud
KMS CryptoKey Encrypter/Decrypter` role, though you may want further scope
access to only your key.

### Create a Workload Identity Pool and Provider

GCP documentation for setting these up can be found at: [Configure Workload
Identity
Federation](https://cloud.google.com/iam/docs/workload-identity-federation-with-other-providers#configure).

Make a note of the name you choose for the **Workload Identity Pool**, for later
use.

When creating the Identity Provider, specify the following details:

- Provider type: Must be OpenID Connect (OIDC).
- Issuer (URL): The address of HCP Terraform, `https://app.terraform.io`.

- Audience: Leave the default value.

- Provider attributes mapping: Set the google.subject value to assertion.sub

- Attribute Conditions: Restrict which identity tokens are authenticated by this
  provider by matching on the subject claim of the JWT minted by HCP Terraform.
  For HYOK, this would be: `organization:<your org name>:hyok_config:<your hyok
  config name>`.

If you would like to use the same provider to access all keys within your
organization, you may use wildcard matching in the condition.
assertion.sub.startsWith("organization:<your org name>:hyok_config:") For
additional security we recommend that you choose a configuration name now, so
that the only workloads requiring a particular key may assume this role.
assertion.sub.startsWith("organization:<your org name>:hyok_config:<your hyok
config name>"). The hyok configuration name can contain letters, numbers,
hyphens, and underscores. Make a note of the chosen configuration name, as you
will need it later to configure HCP Terraform

Note the **your hyok config name** values you choose here, as well as the **pool name** and **provider name**. You will use these values later.

<Note>

GCP has a limit of 127 characters for subject claims. This means
`organization:<your org name>:hyok_config:<your hyok config name>` must be under
127 characters. Make sure to plan your config name accordingly, based on the
length of your organization name.

</Note>

### Grant Service Account Access to the Identity Pool

Finally, you need to grant the workload identity pool access to the service
account by following the steps in: [Allow the external workload to impersonate
the service
account](https://cloud.google.com/iam/docs/workload-identity-federation-with-other-providers#access).

</Tab>
<Tab heading="Vault" group="vault">

There are a few things you need to do to set up Vault with HYOK. These setup
steps include:

- Mount and configure a JWT Authentication backend.
- Mount a transit secrets engine and adding a key.
- Add a role for the tfc-agent to assume, and policies that allow it to use the key.

## Mount and Configure a JWT Authentication backend

If you already have a JWT Authentication backend set up, use that existing
backend. If not, enable it as shown below.

```shell-session
$ vault auth enable -path=jwt-prod jwt
Success! Enabled jwt auth method at: jwt-prod/
```

Configure Vault to trust HCP Terraform’s identity tokens and verify them using
HCP Terraform’s public key. The following command configures the jwt auth
backend in Vault to trust HCP Terraform as an OIDC identity provider:

```shell-session
$ vault write auth/jwt-prod/config \
   oidc_discovery_url="https://app.terraform.io" \
   bound_issuer="https://app.terraform.io"
Success! Data written to: auth/jwt-prod/config
```

<Note>

Exclude any trailing slashes from the HCP Terraform URL.

</Note>

### Create a key

Set up the resource you want to access, which will be the key encryption key you
create in the next step. To do this, enable the Vault’s transit secrets engine
if it is not already enabled, as shown below:

```shell-session
$ vault secrets enable transit
Success! Enabled the transit secrets engine at: transit/
```

Next, create the key which will be used to encrypt and decrypt your data
encryption keys. To do this, give your key a unique name, as shown below. In the
example below, the key name is `unique-prod`:

```shell-session
$ vault write -f transit/keys/unique-prod


Key                       Value
---                       -----
allow_plaintext_backup    false
auto_rotate_period        0s
deletion_allowed          false
derived                   false
exportable                false
imported_key              false
keys                      map[1:1738617996]
latest_version            1
min_available_version     0
min_decryption_version    1
min_encryption_version    0
name                      unique-prod
supports_decryption       true
supports_derivation       true
supports_encryption       true
supports_signing          false
type                      aes256-gcm96
```

Take note of the key name you chose, as you will need to refer to the value
later.

### Configure roles and policies

To add roles and policies, you’ll want to grant entities authenticating with the
JWT auth the ability to encrypt and decrypt with your newly created key
encryption key. This requires a role and an access policy, which grants it
access to the key. Create a new `encrypt-decrypt-policy.hcl` file with the
following contents:

<CodeBlockConfig filename="encrypt-decrypt-policy.hcl">

```hcl
path "transit/encrypt/<your key>" {
 capabilities = [ "create", "update" ]
}
path "transit/decrypt/<your key>" {
 capabilities = [ "create", "update" ]
}
```

</CodeBlockConfig>

Replace "<your key>" with the name of they key you created in the previous step.

```shell-session
$ vault policy write hyok-encrypt-prod encrypt-decrypt-policy.hcl
Success! Uploaded policy: hyok-encrypt-prod
```

Next, create a role that you will grant the policy above to, and that can also
be assumed by the JWT auth endpoint when given a valid HCP Terraform HYOK JWT.
To do this, choose a unique name for the role, as outlined in the example below:

<CodeBlockConfig filename="hyok-prod-role.json">

```hcl
{
 "policies": ["hyok-encrypt-prod"],
 "bound_audiences": ["vault.workload.identity"],
 "bound_claims_type": "glob",
 "bound_claims": {
   "sub": "organization:<your organization name>:hyok_config:*"
 },
 "user_claim": "sub",
 "role_type": "jwt",
 "token_ttl": "20m"
}
```

</CodeblockConfig>

```shell-session
$ vault write auth/jwt-prod/role/unique-prod-role-prod @hyok-prod-role.json
Success! Data written to: auth/jwt-prod/role/unique-prod
```

Replace the following values in the above role configuration:

The policies list needs to include the name of the policy you created. The
bound_audiences list needs to be vault.workload.identity.

Additionally, the bound_claims.sub will match against the subject claim of the
HCP Terraform-issued JWT, which for HYOK is `organization:<your org
name>:hyok_config:<your hyok config name>`. Wildcards are allowed when matching
claims. For example, if you want to use the same role for all keys within your
HCP Terraform organization, you can configure your subject claim to match all
HYOK configurations in your organization: `organization:<the name of your
organization>:hyok_config:*`.

For additional security we recommend that you choose a configuration name now,
so that only the specified HYOK configuration may assume this role.
`organization:<the name of your organization>:hyok_config:<your hyok config
name>`. The hyok configuration name can contain letters, numbers, hyphens, and
underscores.

</Tab>
</Tabs>

## Configure HYOK in HCP Terraform

Once your KMS has been configured with a key encryption key the necessary OIDC
trust relationship to HCP Terraform, the next step is to create an **HYOK
configuration** for your HCP Terraform organization.

Each HYOK configuration in your organization represents a single KMS key
encryption key with potentially multiple key versions. You can configure
multiple keys in different HYOK configurations, across one or many different
KMSs.

Navigate to **Organization Settings** then **HYOK Encryption**. Open the HYOK
configuration wizard by clicking the **Configure a key** button.

### Choose agent pool

On the first step of the wizard, select an agent pool that is hosting agents
with [Request Forwarding
enabled](/terraform/cloud-docs/agents/request-forwarding).

HCP Terraform uses this agent pool to:

- Generate and encrypt data encryption keys for workspaces onboarded with HYOK.
- Re-encrypt data keys when an HYOK configuration is revoked.
- Connect to your KMS to check for new key versions.

It is important that the agent pool contains agents with request forwarding
enabled, or these operations fail.

This agent pool does not get used to perform Terraform runs. HCP Terraform
continues to use the agent pool specified in your workspace's execution mode
when performing runs. These agents do not require any special configuration or
request forwarding, but should be updated to version 1.23.0 or later.

### Configure OIDC settings

The next step of the wizard collects the information needed to authenticate to
your KMS using OIDC. Select your KMS type, and fill in the required information
for your KMS provider. You created these values in the previous step.

<Tabs>
<Tab heading="Azure" group="azure">

To configure your OIDC connection in HCP Terraform, you need the following
values from Azure:

- The Application ID for your Entra ID Application.
- This is also called an Application (client) ID on the EntraID Application
  overview page.
- The Tenant ID for your Entra ID Application. This is also called an Directory
  (tenant) ID on the EntraID Application overview page.
- Your Subscription ID from the Azure subscription overview page.

<Tab heading="AWS" group="aws">

To configure your OIDC connection in HCP Terraform, you need the following
values from AWS:

- Role ARN: The ARN of the IAM role.

</Tab>
<Tab heading="GCP" group="gcp">

To configure your OIDC connection in HCP Terraform, you need the following
values from GCP:

- Service account email: The email of the service account you created in the
  previous step, with permission to encrypt and decrypt using your key.
- Your GCP Project Number for the project containing the Workload Identity
  Provider and service account.
- The fully qualified Workload Provider name, as described
  [here](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/iam_workload_identity_pool_provider?product_intent=terraform#name-1).
  This is in the format
  `projects/{project_number}/locations/global/workloadIdentityPools/{workload_identity_pool_id}/providers/{workload_identity_pool_provider_id}`

</Tab>
<Tab heading="Vault" group="vault">

To configure your OIDC connection in HCP Terraform, you need the following
values from Vault:

- The Address (URL) of your Vault instance, with `https://` included.
- The Role name for the role you created on the JWT-auth endpoint in the
  previous step. In the Vault configuration example this was
  `unique-prod-role-prod`.
- The namespace to use when authenticating to Vault. E.g. `admin`
- The JWT auth path where your jwt auth backend is mounted. By default this will
  be admin. In the Vault configuration example it was jwt-prod.

If you are using Vault Enterprise with a custom CA, enter the TLS CA Certificate
which authenticates it.

</Tab>
</Tabs>

### Configure key settings

On the final page of the wizard, tell HCP Terraform which key to use for this
HYOK configuration.

Provide the configuration with a unique name to identify it within HCP Terraform. Your configuration name can be any combination of letters, numbers, hyphens, and underscores, and is included in the subject claim of HYOK JWTs issued by HCP Terraform. So if you configured your KMS to match against your hyok_config name, make sure to use the same name for your HYOK configuration..

<Tabs>
<Tab heading="Azure" group="azure">

To configure your key in HCP Terraform, you will need the following values from Vault:
The full Key URI for the key you created in the previous step.
This is in the format https://<key vault name>.vault.azure.net/keys/<key name>

</Tab>
<Tab heading="AWS" group="aws">

To configure your key in HCP Terraform, you will need the following values from AWS:
The full Key ARN for the KMS key you created in the previous step.
The Region that the key is located in.

</Tab>
<Tab heading="GCP" group="gcp">

The Key Ring Name for the key ring you created in the previous step.
The Key Name for the specific key in that ring.
The Location that the key ring was created in.
E.g. global

</Tab>
<Tab heading="Vault" group="vault">

The Name of the key you created in the Transit secrets engine.
In the Vault configuration example above, this was unique-prod

</Tab>
</Tabs>

## Test the key configuration

To test your HYOK configuration, click Test Connection on the last step of the
Configure a new key wizard during set up. Clicking this button causes HCP
Terraform to attempt to authenticate to your KMS and test that basic encryption
and decryption works.

Once a configuration is saved, you can also access the button on the General
settings page for the HYOK configuration.

If HCP Terraform cannot successfully connect to your KMS and use your key to
encrypt and decrypt data, an error message will appear. The most likely cause of
failures are:

- There are no agents with Request Forwarding enabled running in the chosen
  Agent Pool.
- Permissions have not been set correctly in your KMS.
- The required resources are not fully provisioned in the KMS. In rare cases, it
  can take up to 15 minutes for keys to be accessible to HCP Terraform after
  being created in the KMS, particularly in the case of Azure or GCP.

## Use a key configuration to encrypt a workspace

Explain promoting keys and how to enable key for workspace (highlight you can’t
turn this off) Once you have followed the steps laid out in the previous
sections, the next step is to update your primary configuration.

When HYOK is enabled for a workspace, HCP Terraform uses the primary
configuration to secure that workspace. When you revoke an HYOK configuration in
HCP Terraform, it migrates all of the workspaces that used the revoked
configuration to use the primary configuration.

To manually promote a configuration to primary, navigate to your organization's
Settings, and then to HYOK Encryption. Click Promote to primary on the desired
configuration. Promotion to primary will also happen automatically for the first
HYOK configuration with a status of "Available".

Once you’ve configured HCP Terraform to use your key, select a workspace to
encrypt data for by enabling HYOK for that workspace. Please note that once HYOK
is enabled for a workspace, it cannot be reversed. Once you enable HYOK on a
given workspace, HCP Terraform will generate a data encryption key, connect to
your KMS to encrypt it with your key encryption key, and store the encrypted
DEK.

To enable HYOK for a workspace, go to a workspace’s settings, and navigate to
HYOK Encryption. Check Enable HYOK for this workspace to enable HYOK and encrypt
data for the state and plan files in your workspace.

Any future runs on this workspace now produce encrypted state and plan files.
You can test this by performing a run. State versions are annotated with the
name of the HYOK configuration securing them:

## Revoke a key configuration

HCP Terraform keeps track of which HYOK configurations are used to secure each
of your workspace’s artifacts. If you wish to stop using a given KEK or a
specific key version, you may revoke it within HCP Terraform. For example, if a
key version is too old or has been leaked, then revoking it in HCP Terraform
instructs the platform to stop using that key for encryption, and to migrate all
existing data off of it.

An important distinction to make is that HCP Terraform does not manage keys within your KMS. Meaning, that revoking a key configuration in HCP Terraform does not revoke that key within your KMS. Revoking a key configuration in HCP Terraform lets you migrate data off of the key, letting you can then revoke and safely delete the corresponding key from your KMS.

When a key version is revoked within HCP Terraform, HCP Terraform automatically
re-secures all of the artifacts it currently secures with the latest version of
the same key. When an entire HYOK configuration is revoked, HCP Terraform
re-secures the artifacts with the primary configuration.

When a key or key version is revoked, HCP Terraform does not need to directly
re-encrypt all the artifacts it secures. Instead, HCP Terraform uses an HCP
Terraform agent to re-encrypt all of the DEKs that are encrypted with that key.
This makes the re-encryption process much quicker and requires less transferring
data than re-encrypting the artifacts themselves.

HCP Terraform cannot manage the keys within your KMS: revoking a key in HCP
Terraform does not revoke the key in the KMS. Rather, it allows you to migrate
data off of the key, so that it can be revoked and/or deleted safely from the
KMS.

In order to safely revoke a key being used by HCP Terraform in your KMS, you
must:

1. Revoke the key in HCP Terraform.
1. Wait until all workspaces have been migrated off of the key, which you can
   check in the HYOK Encryption organization UI.
1. Revoke the key in the KMS itself.
