name: Build dev-portal Preview for PR
run-name: 'Build dev-portal preview for PR #${{ github.event.pull_request.number }}${{ github.event.pull_request.title }}'

on:
  pull_request: {}
env:
  DEV_PORTAL_ID: prj_kxbbGoGdwKkIuEsMRVwetBX5lmgg
  VERCEL_TEAM_ID: team_kRChqe754SOcJudYPP6rroKH
  VERCEL_UNIFIED_DOCS_ID: prj_8gMrDMdPkLtKYwOEEdJLfuGXNEYF

jobs:
  deploy-dev-portal-preview:
    name: Deploy Dev Portal Preview
    runs-on: ubuntu-latest
    steps:
      - name: Get Unified Docs API URL
        uses: ./actions/get-vercel-preview-url
        id: unified_docs_preview_url
        env: 
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        with:
          vercel_project_id: ${{ env.VERCEL_UNIFIED_DOCS_ID }}
          vercel_team_id: ${{ env.VERCEL_TEAM_ID }}

      - name: Checkout hashicorp/dev-portal (Frontend)
        uses: actions/checkout@v4
        with:
          repository: hashicorp/dev-portal
          path: ./unified-docs-frontend-preview

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'unified-docs-frontend-preview/package-lock.json'

      - name: Setup Vercel CLI
        run: npm i --global vercel@latest

      - run: vercel pull --yes --environment=preview --scope=hashicorp --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: unified-docs-frontend-preview

      - name: Build dev-portal
        env:
          HASHI_ENV: preview
          MKTG_CONTENT_DOCS_API: https://content.hashicorp.com
          UNIFIED_DOCS_API: "https://${{ steps.unified_docs_preview_url.outputs.preview_url }}"
          IS_CONTENT_PREVIEW: true
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: unified-docs-frontend-preview

      - name: Deploy preview
        run: vercel deploy --prebuilt --scope=hashicorp --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: unified-docs-frontend-preview
