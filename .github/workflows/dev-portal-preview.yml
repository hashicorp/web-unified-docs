name: Build dev-portal Preview for PR
run-name: 'Build dev-portal preview for PR ${{ github.event.pull_request.title }} (#${{ github.event.pull_request.number }})'

on:
  pull_request: {}

jobs:
  deploy-dev-portal-preview:
    name: Deploy Dev Portal Preview
    runs-on: ubuntu-latest
    steps:
      - name: Initial comment on PR
        uses: marocchino/sticky-pull-request-comment@331f8f5b4215f0445d3c07b4967662a32a2d3e31 # v2.9.0
        with:
          header: preview-notice
          message: |
            ## Deploying previews...
            | Status | Preview |
            | :------ | :------ |
            | ðŸ”„ In progress | ([Inspect](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})) |
      - uses: actions/checkout@v4
      - name: Get Unified Docs API URL
        uses: ./.github/actions/get-vercel-preview-url
        id: unified_docs_preview_url
        with:
          project_id: ${{ secrets.VERCEL_UNIFIED_DOCS_PROJECT_ID }}
          team_id: ${{ secrets.VERCEL_TEAM_ID }}
          vercel_token: ${{ secrets.VERCEL_TOKEN }}

      - name: Checkout hashicorp/dev-portal (Frontend)
        uses: actions/checkout@v4
        with:
          repository: hashicorp/dev-portal
          path: ./unified-docs-frontend-preview

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'unified-docs-frontend-preview/package-lock.json'

      - name: Setup Vercel CLI
        run: npm i --global vercel@latest

      - run: vercel pull --yes --environment=preview --scope=hashicorp --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: unified-docs-frontend-preview

      - name: Build dev-portal
        env:
          HASHI_ENV: preview
          UNIFIED_DOCS_API: "https://${{ steps.unified_docs_preview_url.outputs.preview_url }}"
          IS_CONTENT_PREVIEW: true
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: unified-docs-frontend-preview

      - name: Deploy dev-portal preview
        id: deploy_dev_portal_preview
        run: |
          DEV_PORTAL_PREVIEW_URL=$(vercel deploy --prebuilt --archive=tgz --scope=hashicorp --token=${{ secrets.VERCEL_TOKEN }})
          echo "DEV_PORTAL_PREVIEW_URL=$DEV_PORTAL_PREVIEW_URL" >> $GITHUB_OUTPUT
        working-directory: unified-docs-frontend-preview

      - name: Update comment with preview URL
        uses: marocchino/sticky-pull-request-comment@331f8f5b4215f0445d3c07b4967662a32a2d3e31 # v2.9.0
        with:
          header: preview-notice
          message: |
            ## Dev Portal Preview Deployed
            | Status | Preview |
            | :------ | :------ |
            | âœ… Ready | [View Preview](${{ steps.deploy_dev_portal_preview.outputs.DEV_PORTAL_PREVIEW_URL }}) |