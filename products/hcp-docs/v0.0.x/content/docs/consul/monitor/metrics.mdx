---
page_title: Metrics from HashiCorp-managed clusters
description: |-
  Learn how to scrape a HashiCorp-managed cluster's server metrics using Prometheus or OpenTelemetry Collector.
---

# Metrics from HashiCorp-managed clusters

This page describes how to scrape [Consul server metrics](/consul/docs/agent/telemetry) from HashiCorp-managed clusters.

HashiCorp [ensures the availability of HashiCorp-managed clusters](/hcp/docs/consul/concepts/cluster-management) and provides observability features through [HCP Consul Central](/hcp/docs/consul/concepts/consul-central). You can set up a custom metrics collector to track cluster usage.

For opinionated, preconfigured graphs of Consul server and Envoy proxy metrics, refer to the [HCP Consul observability overview](/hcp/docs/consul/monitor/consul-central/observability).

## Prerequisites

To access server metrics, you need a telemetry agent capable of both resolving a DNS record to IP addresses and scraping Prometheus-format metrics. This page provides example configurations for [Prometheus](https://prometheus.io/download/) and [OpenTelemetry Collector using Docker](https://opentelemetry.io/docs/collector/getting-started/#docker).

Accessing server metrics requires the cluster's address and an ACL token with a minimum of [`agent:read` permission](/consul/docs/security/acl/acl-rules). To get the cluster's address and create an ACL token using HCP Consul, refer to [Access HashiCorp-managed clusters](/hcp/docs/consul/hcp-managed/access).

## Scrape server metrics

Configure your telemetry collector to scrape metrics from the cluster's `/v1/agent/metrics` endpoint and then start the collector. The following examples demonstrate configurations for Prometheus and OpenTelemetry Collector.

### Prometheus

To use a Prometheus metrics collector, configure it to do the following:

1. Resolve the cluster's [DNS address to IP addresses](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config).
1. Scrape metrics from each server's [`/v1/agent/metrics` endpoint](/consul/api-docs/agent#view-metrics).
1. Call the agent endpoint with a Bearer token authorized to read metrics.

In the following example configuration, these fields are specified so that the collector scrapes agent metrics every 60 minutes by running a job named `hcp-consul-cluster`.

<CodeBlockConfig filename="scrape.yaml">

```yaml
---
global:
  scrape_interval: "60s"

scrape_configs:
  - job_name: "hcp-consul-cluster"

    # Resolve the IP addresses of servers.
    scheme: "https"
    dns_sd_configs:
      - names:
          - "<consul-cluster-name.consul.alphanumeric-id.aws.hashicorp.cloud>"
        type: "A"
        port: 443

    # Set the Consul token as the Bearer token.
    authorization:
      credentials: "<token>"

    # Query the agent metrics endpoint.
    metrics_path: "/v1/agent/metrics"

    # Disable TLS verification.
    tls_config:
      insecure_skip_verify: true
```

</CodeBlockConfig>

To start the metrics collector, run the following command:

```shell-session
$ prometheus --config.file=scrape.yaml
```

### OpenTelemetry Collector

You can use the [Prometheus Receiver in the OpenTelemetry Collector](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/prometheusreceiver) to scrape metrics from a HashiCorp-managed cluster.

The following example configures a metrics pipeline with a [Processor](https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/batchprocessor/README.md) and [Exporter](https://github.com/open-telemetry/opentelemetry-collector/tree/main/exporter/otlpexporter). The OTLP Exporter requires an OTLP gRPC endpoint. Observability platforms such as [New Relic](https://docs.newrelic.com/docs/more-integrations/open-source-telemetry-integrations/opentelemetry/get-started/opentelemetry-set-up-your-app/) and [Honeycomb](https://docs.honeycomb.io/getting-data-in/opentelemetry-overview/#using-the-honeycomb-opentelemetry-endpoint) have public endpoints for metrics ingestion. Others platforms such as Datadog have [their own Exporter](https://docs.datadoghq.com/opentelemetry/otel_collector_datadog_exporter).

<CodeBlockConfig filename="config.yaml">

```yaml
---
receivers:
  prometheus:
    config:
      global:
        scrape_interval: "60s"
      scrape_configs:
        - job_name: "hcp-consul-cluster"
          scheme: "https"
          dns_sd_configs:
            - names:
                - "<consul-cluster-name.consul.alphanumeric-id.aws.hashicorp.cloud>"
              type: "A"
              port: 443
          authorization:
            credentials: "<token>"
          metrics_path: "/v1/agent/metrics"
          tls_config:
            insecure_skip_verify: true

processors:
  batch:
    send_batch_max_size: 1000
    send_batch_size: 100
    timeout: "60s"

exporters:
  otlp:
    endpoint: "<otlp-compatible-endpoint>"

service:
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [batch]
      exporters: [otlp]
```

</CodeBlockConfig>

To [start the Collector in a Docker container](https://opentelemetry.io/docs/collector/getting-started/#docker), run the following command:

```shell-session
$ docker run -v $(pwd)/config.yaml:/etc/otelcol-contrib/config.yaml otel/opentelemetry-collector-contrib:0.86.0
```
